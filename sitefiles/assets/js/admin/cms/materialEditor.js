var $url="/cms/material/editor",$urlUpdate=$url+"/actions/update",$urlPreview=$url+"/actions/preview",data=utils.init({siteId:utils.getQueryInt("siteId"),page:utils.getQueryInt("page"),tabName:utils.getQueryString("tabName"),messageId:utils.getQueryInt("messageId"),groupId:utils.getQueryInt("groupId"),mainHeight:"",editor:null,previewDialog:!1,previewForm:{wxNames:null},items:null,commentTypes:null,siteType:null,form:null,action:null}),methods={runMaterialLayerArticlesSubmit:function(t,e){var i=this;if(e){var s=this.items.findIndex(function(t){return t.id===e});this.items.splice(s,1)}t&&t.length>0&&(t.forEach(function(t){i.items.find(function(e){return e.id===t.id})||i.items.push(t)}),this.form=t[0],this.editor.setContent(this.form.content))},runMaterialLayerImageUploadText:function(t){this.form.thumbUrl=t},runMaterialLayerImageUploadEditor:function(t){t&&(this.form.content=this.editor.getContent()+"<br />"+t,this.editor.setContent(this.form.content))},runEditorLayerImage:function(t,e){this.insertHtml(e)},insertEditor:function(t,e){t||(t="Body"),e&&utils.getEditor(t).execCommand("insertHTML",e)},insertHtml:function(t){t&&this.editor.execCommand("insertHTML",t)},apiGet:function(){var t=this;utils.loading(this,!0),$api.get($url,{params:{messageId:this.messageId,siteId:this.siteId}}).then(function(e){var i=e.data;t.items=i.items,t.commentTypes=i.commentTypes,t.siteType=i.siteType,t.form=t.items[0],setTimeout(function(){t.editor=utils.getEditor("editor"),t.editor.ready(function(){this.addListener("contentChange",function(){t.form.content=this.getContent()})}),window.onresize=function(){t.mainHeight=$(window).height()-70+"px"},window.onresize()},100)}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},apiCreate:function(){var t=this;utils.loading(this,!0),$api.post($url,{groupId:this.groupId,items:this.items}).then(function(e){var i=e.data;if(t.messageId=i.messageId,"preview"===t.action)t.apiPreview();else if("send"===t.action){(s=utils.getTabVue(t.tabName))&&s.apiGet(t.page),utils.success("保存成功！"),utils.removeTab(),utils.addTab("新建群发",utils.getCmsUrl("openSend",{siteId:t.siteId,messageId:t.messageId}))}else{var s;utils.success("创建图文消息成功！"),utils.removeTab(),(s=utils.getTabVue(t.tabName))&&s.apiGet(t.page)}}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},apiUpdate:function(){var t=this;utils.loading(this,!0),$api.post($urlUpdate,{messageId:this.messageId,groupId:this.groupId,items:this.items}).then(function(e){e.data;if("preview"===t.action)t.apiPreview();else if("send"===t.action){(i=utils.getTabVue(t.tabName))&&i.apiGet(t.page),utils.success("保存成功！"),utils.removeTab(),utils.addTab("新建群发",utils.getCmsUrl("openSend",{siteId:t.siteId,messageId:t.messageId}))}else{var i;utils.success("修改图文消息成功！"),utils.removeTab(),(i=utils.getTabVue(t.tabName))&&i.apiGet(t.page)}}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},apiPreview:function(){var t=this;utils.loading(this,!0),$api.post($urlPreview,{siteId:this.siteId,messageId:this.messageId,wxNames:this.previewForm.wxNames}).then(function(e){e.data;t.previewDialog=!1,utils.success("预览图文消息已发送至微信，请进入微信查看！")}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},btnItemClick:function(t){this.form=t,this.editor.setContent(t.content)},btnAddClick:function(t){if("new"===t)this.form={},this.editor.setContent(""),this.items.push(this.form);else if("select"===t){var e=this.items.filter(function(t){return"Article"===t.materialType}).map(function(t){return t.materialId}).join(",");utils.openLayer({title:"选择图文",url:utils.getCommonUrl("materialLayerArticleSelect",{siteId:this.siteId,articleIds:e})})}},btnMenuSelect:function(t){var e=t.split(":")[0],i=t.split(":")[1],s=this.items[i];if("select"===e){var n=this.items.filter(function(t){return"Article"===t.materialType}).map(function(t){return t.materialId}).join(",");utils.openLayer({title:"选择图文",url:utils.getCommonUrl("materialLayerArticleSelect",{siteId:this.siteId,itemId:s.id,articleIds:n})})}else"up"===e?(this.items.splice(i,1),this.items.splice(i-1,0,s),this.btnItemClick(s)):"down"===e?(this.items.splice(i,1),this.items.splice(i+1,0,s),this.btnItemClick(s)):"delete"===e&&(this.btnItemClick(this.items[0]),this.items.splice(i,1));return!1},btnLayerClick:function(t){utils.openLayer({title:t.title,url:utils.getCommonUrl("editorLayer"+t.name,{siteId:this.siteId,attributeName:t.attributeName}),full:t.full,width:t.width?t.width:700,height:t.height?t.height:500})},btnUploadClick:function(){utils.openLayer({title:"上传封面",url:utils.getCmsUrl("materialLayerImageUpload",{siteId:this.siteId,editorAttributeName:"Body"}),width:700,height:500})},btnSubmitClick:function(){var t=this;this.$refs.form.validate(function(e){if(!e)return utils.error("标题及内容为必填项，请填写后提交保存！");for(var i=0;i<t.items.length;i++){var s=t.items[i];if(!s.title||!s.content)return t.btnItemClick(s),utils.error("标题及内容为必填项，请填写后提交保存！")}0===t.messageId?t.apiCreate():t.apiUpdate()})},btnPreviewClick:function(){this.previewDialog=!0},btnSendClick:function(){this.action="send",this.btnSubmitClick()},btnCloseClick:function(){utils.removeTab()},btnPreviewSubmitClick:function(){var t=this;this.$refs.previewForm.validate(function(e){e&&(t.action="preview",t.btnSubmitClick())})}},$vue=new Vue({el:"#main",data:data,computed:{wxNamesCount:function(t,e){return this.previewForm.wxNames?this.previewForm.wxNames.split("\n").length:1}},methods:methods,created:function(){utils.keyPress(this.btnSubmitClick,this.btnCloseClick),this.apiGet()}});