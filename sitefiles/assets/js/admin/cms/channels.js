var $url="/cms/channels/channels",$urlUpdate=$url+"/actions/update",$urlDelete=$url+"/actions/delete",data=utils.init({siteId:utils.getQueryInt("siteId"),root:null,indexNames:[],groupNames:[],channelTemplates:[],contentTemplates:[],defaultChannelTemplate:null,defaultContentTemplate:null,columns:null,commandsWidth:160,isTemplateEditable:!1,expandedChannelIds:[],editLinkTypes:[],editTaxisTypes:[],siteUrl:null,settings:null,channelMenus:null,channelsMenus:null,styles:[],relatedFields:null,channelIds:[],filterText:"",filterIndexName:"",filterGroupName:"",appendPanel:!1,appendForm:null,editPanel:!1,form:null,deletePanel:!1,deleteForm:null,importPanel:!1,importForm:null,importUploadList:[]}),methods={apiList:function(e){var t=this;utils.loading(this,!0),$api.get($url,{params:{siteId:this.siteId}}).then(function(n){var i=n.data;t.root=[i.channel],t.indexNames=i.indexNames,t.groupNames=i.groupNames,t.channelTemplates=i.channelTemplates,t.contentTemplates=i.contentTemplates,t.defaultChannelTemplate=t.channelTemplates.find(function(e){return e.defaultTemplate}),t.defaultContentTemplate=t.contentTemplates.find(function(e){return e.defaultTemplate}),t.columns=i.columns,t.commandsWidth=i.commandsWidth,t.isTemplateEditable=i.isTemplateEditable,t.expandedChannelIds=e||[t.siteId],t.editLinkTypes=i.linkTypes,t.editTaxisTypes=i.taxisTypes,t.siteUrl=i.siteUrl,t.settings=i.settings,t.channelMenus=i.channelMenus,t.channelsMenus=i.channelsMenus}).catch(function(e){utils.error(e)}).then(function(){utils.loading(t,!1)})},apiGet:function(e){var t=this;utils.loading(this,!0),$api.get($url+"/"+this.siteId+"/"+e).then(function(e){var n=e.data;t.form=_.assign({},n.entity,n.linkTo),t.form.groupNames||(t.form.groupNames=[]),t.styles=n.styles,t.relatedFields=n.relatedFields,t.form.filePath=n.filePath,t.form.channelFilePathRule=n.channelFilePathRule,t.form.contentFilePathRule=n.contentFilePathRule,t.editPanel=!0,utils.loadEditors(t.styles,t.form)}).catch(function(e){utils.error(e)}).then(function(){utils.loading(t,!1)})},apiAppend:function(){var e=this;utils.loading(this,!0),$api.post($url+"/actions/append",{siteId:this.siteId,parentId:this.appendForm.parentIds[this.appendForm.parentIds.length-1],channelTemplateId:this.appendForm.channelTemplateId,contentTemplateId:this.appendForm.contentTemplateId,isParentTemplates:this.appendForm.isParentTemplates,isIndexName:this.appendForm.isIndexName,channels:this.appendForm.channels}).then(function(t){var n=t.data;e.appendPanel=!1,e.apiList(n),utils.success("栏目添加成功!")}).catch(function(t){utils.loading(e,!1),utils.error(t)})},apiUpdate:function(){var e=this;utils.loading(this,!0),$api.post($urlUpdate,this.form).then(function(t){var n=t.data;e.editPanel=!1,e.apiList(n),utils.success("栏目编辑成功!")}).catch(function(t){utils.loading(e,!1),utils.error(t)})},apiDelete:function(){var e=this;utils.loading(this,!0),$api.post($urlDelete,this.deleteForm).then(function(t){var n=t.data;e.deletePanel=!1,e.apiList(n),utils.success("栏目删除成功!")}).catch(function(t){utils.loading(e,!1),utils.error(t)})},apiImport:function(){var e=this;utils.loading(this,!0),$api.post($url+"/actions/import",{siteId:this.importForm.siteId,channelId:this.importForm.channelIds[this.importForm.channelIds.length-1],fileName:this.importForm.fileName,isOverride:this.importForm.isOverride}).then(function(t){var n=t.data;e.importPanel=!1,e.apiList(n),utils.success("栏目导入成功!")}).catch(function(t){utils.loading(e,!1),utils.error(t)})},apiDrop:function(e,t,n){var i=this;utils.loading(this,!0),$api.post($url+"/actions/drop",{siteId:this.siteId,sourceId:e,targetId:t,dropType:n}).then(function(e){e.data;utils.success("栏目排序成功!")}).catch(function(e){utils.error(e)}).then(function(){utils.loading(i,!1)})},apiColumns:function(e){$api.post($url+"/actions/columns",{siteId:this.siteId,attributeNames:e}).then(function(e){e.data}).catch(function(e){utils.error(e)})},runFormLayerImageUploadText:function(e,t,n){this.insertText(e,t,n)},runFormLayerImageUploadEditor:function(e,t){this.insertEditor(e,t)},runMaterialLayerImageSelect:function(e,t,n){this.insertText(e,t,n)},runFormLayerFileUpload:function(e,t,n){this.insertText(e,t,n)},runMaterialLayerFileSelect:function(e,t,n){this.insertText(e,t,n)},runFormLayerVideoUpload:function(e,t,n){this.insertText(e,t,n)},runMaterialLayerVideoSelect:function(e,t,n){this.insertText(e,t,n)},runEditorLayerImage:function(e,t){this.insertEditor(e,t)},runLayerContentSelect:function(e){this.form.contentId=e.id,this.form.contentTitle=e.title},getContentUrl:function(){return utils.getRootUrl("redirect",{siteId:this.siteId,channelId:this.form.channelIds[this.form.channelIds.length-1],contentId:this.form.contentId})},insertText:function(e,t,n){(this.form[utils.getCountName(e)]||0)<=t&&(this.form[utils.getCountName(e)]=t),this.form[utils.getExtendName(e,t)]=n,this.form=_.assign({},this.form)},insertEditor:function(e,t){e||(e="Body"),t&&utils.getEditor(e).execCommand("insertHTML",t)},setRuleText:function(e,t){t?this.form.channelFilePathRule=e:this.form.contentFilePathRule=e},updateGroups:function(e,t){this.groupNames=e.groupNames,utils.success(t)},handleColumnsChange:function(){var e=_.filter(this.columns,function(e){return e.isList}),t=_.map(e,function(e){return e.attributeName});this.apiColumns(t)},btnSetClick:function(e,t,n){var i=utils.getCmsUrl("settingsCreateRuleLayerSet",{siteId:this.siteId,isChannel:t,channelId:e,rule:n||""});utils.openLayer({title:"构造",url:i,width:800,height:550})},btnLinkToContentClick:function(){var e=this.form.channelIds[this.form.channelIds.length-1];utils.openLayer({title:"选择指定内容",url:utils.getCmsUrl("layerContentSelect",{siteId:this.siteId,channelId:e,contentId:0})})},getColumnWidth:function(e){return"Id"===e?80:"ChannelTemplateId"===e||"ContentTemplateId"===e?120:"IndexName"===e?120:180},getTemplate:function(e,t){var n=null;return(n=e?this.channelTemplates.find(function(e){return e.id===t}):this.contentTemplates.find(function(e){return e.id===t}))||(n=e?this.defaultChannelTemplate:this.defaultContentTemplate),n},getTemplateEditorUrl:function(e,t){return utils.getCmsUrl("templatesEditor",{siteId:this.siteId,templateId:t,templateType:e?"ChannelTemplate":"ContentTemplate",accessToken:$token})},btnEditAddGroupClick:function(){utils.openLayer({title:"新增栏目组",url:utils.getCommonUrl("groupChannelLayerAdd",{siteId:this.siteId}),width:500,height:300})},btnImageSelectClick:function(e){var t=e.inputType,n=e.attributeName,i=e.no,a=e.type;"uploadedImages"===a?this.btnLayerClick({title:"选择已上传图片",name:"formLayerImageSelect",inputType:t,attributeName:n,no:i,full:!0}):"materialImages"===a?this.btnLayerClick({title:"选择素材库图片",name:"materialLayerImageSelect",inputType:t,attributeName:n,no:i,full:!0}):"cloudImages"===a&&utils.openLayer({title:"选择免版权图库",url:utils.getCloudsUrl("layerImagesSelect",{inputType:t,attributeName:e.attributeName,no:e.no})})},handleDrop:function(e,t,n,i){this.apiDrop(e.data.value,t.data.value,n)},allowDrop:function(e,t,n){return t.data.value!==this.siteId},allowDrag:function(e){return e.data.value!==this.siteId},getChannelUrl:function(e){return utils.getRootUrl("redirect",{siteId:this.siteId,channelId:e.value})},handleCheckChange(){this.channelIds=this.$refs.tree.getCheckedKeys()},btnCheckClick:function(e){-1!==this.channelIds.indexOf(e.value)?this.channelIds.splice(this.channelIds.indexOf(e.value),1):this.channelIds.push(e.value),this.$refs.tree.setCheckedKeys(this.channelIds)},filterNode:function(e,t){return!e||(e.channelName&&e.indexName&&e.groupName?(-1!==t.label.indexOf(e.channelName)||t.value+""===e.channelName)&&t.channel.indexName===e.indexName&&-1!==t.groupNames.indexOf(e.groupName):e.channelName&&e.indexName?(-1!==t.label.indexOf(e.channelName)||t.value+""===e.channelName)&&t.channel.indexName===e.indexName:e.channelName&&e.groupName?(-1!==t.label.indexOf(e.channelName)||t.value+""===e.channelName)&&-1!==t.groupNames.indexOf(e.groupName):e.indexName&&e.groupName?t.channel.indexName===e.indexName&&-1!==t.groupNames.indexOf(e.groupName):e.channelName?-1!==t.label.indexOf(e.channelName)||t.value+""===e.channelName:e.groupName?-1!==t.groupNames.indexOf(e.groupName):!e.indexName||t.channel.indexName===e.indexName)},btnCancelClick:function(){this.appendPanel=!1,this.deletePanel=!1,this.importPanel=!1,this.editPanel=!1},btnAppendClick:function(){this.appendForm={parentIds:[this.siteId],channelTemplateId:0,contentTemplateId:0,isParentTemplates:!0,isIndexName:!1,channels:""},this.appendPanel=!0},btnAppendSubmitClick:function(){var e=this;this.$refs.appendForm.validate(function(t){t&&e.apiAppend()})},btnEditClick:function(e){this.apiGet(e.value)},btnSaveClick:function(){var e=this;this.$refs.editForm.validate(function(t){t&&e.apiUpdate()})},btnDeleteClick:function(e){this.siteId!=e.value&&(this.deleteForm={siteId:this.siteId,channelId:e.value,label:e.label,channelName:null,deleteFiles:!1},this.deletePanel=!0)},btnDeleteSubmitClick:function(){var e=this;this.$refs.deleteForm.validate(function(t){t&&(e.deleteForm.channelName==e.deleteForm.label?e.apiDelete():utils.error("请检查您输入的栏目名称是否正确"))})},btnImportClick:function(){this.importForm={siteId:this.siteId,channelIds:[this.siteId],fileName:null,isOverride:!0},this.importPanel=!0},btnTranslateClick:function(){location.href=utils.getCmsUrl("channelsTranslate",{siteId:this.siteId,channelIds:this.channelIds.join(","),returnUrl:location.href})},btnImportSubmitClick:function(){var e=this;this.$refs.importForm.validate(function(t){t&&e.apiImport()})},btnExportClick:function(){var e=this;utils.loading(this,!0),$api.post($url+"/actions/export",{siteId:this.siteId,channelIds:this.channelIds}).then(function(e){var t=e.data;window.open(t.value)}).catch(function(e){utils.error(e)}).then(function(){utils.loading(e,!1)})},btnSetGroupClick:function(){utils.openLayer({title:"设置栏目组",url:utils.getCmsUrl("channelsLayerGroup",{siteId:this.siteId,channelIds:this.channelIds.join(",")}),width:700,height:400})},btnSetTaxisClick:function(){utils.openLayer({title:"栏目排序",url:utils.getCmsUrl("channelsLayerTaxis",{siteId:this.siteId,channelIds:this.channelIds.join(",")}),width:500,height:260})},btnCreateClick:function(){utils.openLayer({title:"生成页面",url:utils.getCmsUrl("channelsLayerCreate",{siteId:this.siteId,channelIds:this.channelIds.join(",")}),width:500,height:260})},btnMenuClick:function(e,t){var n=utils.addQuery(e.link,{siteId:this.siteId,channelId:t.value});"_layer"==e.target?utils.openLayer({title:e.text,url:n,full:!0}):"_self"==e.target?location.href=n:"_parent"==e.target?parent.location.href=n:"_top"==e.target?top.location.href=n:"_blank"==e.target?window.open(n):utils.addTab(e.text,n)},uploadBefore(e){var t=-1!==e.name.indexOf(".zip",e.name.length-".zip".length);return t||utils.error("导入文件只能是 Zip 格式!"),t},uploadProgress:function(){utils.loading(this,!0)},uploadSuccess:function(e,t){this.loading&&this.loading.close(),this.importForm.fileName=e.value},uploadError:function(e){this.loading&&this.loading.close();var t=JSON.parse(e.message);utils.error(t.message)},btnLayerClick:function(e){var t={siteId:this.siteId,editorAttributeName:"Content"};e.inputType&&(t.inputType=e.inputType),e.attributeName&&(t.attributeName=e.attributeName),e.no&&(t.no=e.no),e.contentId&&(t.contentId=e.contentId);var n={title:e.title,url:utils.getCommonUrl(e.name,t)};e.full||(n.width=e.width?e.width:700,n.height=e.height?e.height:500),utils.openLayer(n)},btnExtendAddClick:function(e){var t=this.form[utils.getCountName(e.attributeName)]+1;this.form[utils.getCountName(e.attributeName)]=t,this.form[utils.getExtendName(e.attributeName,t)]="",this.form=_.assign({},this.form)},btnExtendRemoveClick:function(e){var t=this.form[utils.getCountName(e.attributeName)];this.form[utils.getCountName(e.attributeName)]=t-1,this.form[utils.getExtendName(e.attributeName,t)]="",this.form=_.assign({},this.form)},btnExtendPreviewClick:function(e,t){for(var n=this.form[utils.getCountName(e)],i=[],a=0;a<=n;a++){var l=this.form[utils.getExtendName(e,a)];l=utils.getUrl(this.siteUrl,l),i.push({src:l})}layer.photos({photos:{start:t,data:i},anim:5})},btnCloseClick:function(){utils.removeTab()}},$vue=new Vue({el:"#main",data:data,methods:methods,watch:{filterText:function(e){this.$refs.tree.filter({channelName:e,indexName:this.filterIndexName,groupName:this.filterGroupName})},filterIndexName:function(e){this.$refs.tree.filter({channelName:this.filterText,indexName:e,groupName:this.filterGroupName})},filterGroupName:function(e){this.$refs.tree.filter({channelName:this.filterText,indexName:this.filterIndexName,groupName:e})}},created:function(){var e=this;utils.keyPress(function(){e.editPanel?e.btnSaveClick():e.appendPanel?e.btnAppendSubmitClick():e.deletePanel&&e.btnDeleteSubmitClick()},function(){e.editPanel||e.appendPanel||e.deletePanel||e.importPanel?e.btnCancelClick():e.btnCloseClick()}),this.uploadUrl=$apiUrl+$url+"/actions/upload?siteId="+this.siteId,this.apiList()}});