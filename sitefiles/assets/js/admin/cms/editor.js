var $url="/cms/editor",$urlInsert=$url+"/actions/insert",$urlUpdate=$url+"/actions/update",$urlPreview=$url+"/actions/preview",$urlTags=$url+"/actions/tags",$urlCensor=$url+"/actions/censor",$urlCensorAddWords=$url+"/actions/censorAddWords",$urlCloudCensor="cms/censor",$urlCloudCensorAddWords="cms/censor/actions/addWords",$urlSpell=$url+"/actions/spell",$urlSpellAddWords=$url+"/actions/spellAddWords",$urlCloudSpell="cms/spell",$urlCloudSpellAddWords="cms/spell/actions/addWords",$regCensor=/<a[^>]*_censor_original=["']([^"']*)["'][^>]*>[^>]*<\/a>/g,$regSpell=/<a[^>]*_spell_original=["']([^"']*)["'][^>]*>[^>]*<\/a>/g;Date.prototype.Format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var s in/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),t)new RegExp("("+s+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[s]:("00"+t[s]).substr((""+t[s]).length)));return e};var data=utils.init({siteId:utils.getQueryInt("siteId"),channelId:utils.getQueryInt("channelId"),contentId:utils.getQueryInt("contentId"),page:utils.getQueryInt("page"),tabName:utils.getQueryString("tabName"),reloadChannelId:utils.getQueryInt("reloadChannelId"),mainHeight:"",isSettings:!0,sideType:"settings",collapseSettings:["checkedLevel","addDate"],collapseMore:["templateId","translates"],csrfToken:null,site:null,siteUrl:null,channel:null,groupNames:null,tagNames:null,checkedLevels:null,linkTypes:null,linkTo:{channelIds:[],contentId:0,contentTitle:""},root:null,styles:null,relatedFields:null,templates:null,form:null,breadcrumbItems:[],translates:[],isPreviewSaving:!1,isScheduledDialog:!1,scheduledForm:{isScheduled:!1,scheduledDate:new Date},settings:null,censorSettings:{isCloudCensor:!1,isCensorText:!1,isCensorTextAuto:!1,isCensorTextIgnore:!1,isCensorTextWhiteList:!1,isCensorPassed:!1,ignoreWords:[],whiteListWords:[],isCensorChecking:!1,activeNames:[]},censorResults:null,spellSettings:{isCloudSpell:!1,isSpellingCheck:!1,isSpellingCheckAuto:!1,isSpellingCheckIgnore:!1,isSpellingCheckWhiteList:!1,isSpellPassed:!1,ignoreWords:[],whiteListWords:[],isSpellChecking:!1},spellResults:null}),methods={apiGet:function(){var e=this;window.onresize=function(){e.mainHeight=$(window).height()-70+"px"},window.onresize(),$api.get($url,{params:{siteId:e.siteId,channelId:e.channelId,contentId:e.contentId}}).then(function(t){var s=t.data;if(s.channel.isChangeBanned)return utils.alertWarning({title:"禁止修改内容",text:"栏目已开启禁止维护内容(添加/修改/删除)功能，修改内容请先在栏目中关闭此功能！",callback:function(){utils.removeTab()}});e.csrfToken=s.csrfToken,e.site=s.site,e.siteUrl=s.siteUrl,e.channel=s.channel,e.groupNames=s.groupNames,e.tagNames=s.tagNames,e.checkedLevels=s.checkedLevels,e.linkTypes=s.linkTypes,e.linkTo=s.linkTo,e.root=[s.root],e.settings=s.settings,e.censorSettings=_.assign({},e.censorSettings,s.settings.censorSettings,{isCloudCensor:s.settings.isCloudCensor}),e.spellSettings=_.assign({},e.spellSettings,s.settings.spellSettings,{isCloudSpell:s.settings.isCloudSpell}),e.styles=s.styles,e.relatedFields=s.relatedFields,e.templates=s.templates,e.form=_.assign({},s.content),e.breadcrumbItems=s.breadcrumbItems,e.scheduledForm.isScheduled=s.isScheduled,e.scheduledForm.scheduledDate=s.scheduledDate,e.form.addDate?e.form.addDate=new Date(e.form.addDate).Format("yyyy-MM-dd hh:mm:ss"):e.form.addDate=(new Date).Format("yyyy-MM-dd hh:mm:ss"),e.form.checked&&(e.form.checkedLevel=e.site.checkContentLevel),e.checkedLevels.find(t=>t.value===e.form.checkedLevel)||(e.form.checkedLevel=s.checkedLevel),(e.form.top||e.form.recommend||e.form.hot||e.form.color)&&e.collapseSettings.push("attributes"),e.form.groupNames&&e.form.groupNames.length>0?e.collapseSettings.push("groupNames"):e.form.groupNames=[],e.form.tagNames&&e.form.tagNames.length>0?e.collapseSettings.push("tagNames"):e.form.tagNames=[],(e.form.linkType&&"None"!=e.form.linkType||e.form.linkUrl)&&e.collapseSettings.push("link");for(var i=0;i<e.styles.length;i++){var n=e.styles[i];if("CheckBox"===n.inputType||"SelectMultiple"===n.inputType){var l=e.form[utils.toCamelCase(n.attributeName)];Array.isArray(l)||(e.form[utils.toCamelCase(n.attributeName)]=l?utils.toArray(l):[])}else"Image"===n.inputType||"File"===n.inputType||"Video"===n.inputType?e.form[utils.getCountName(n.attributeName)]=utils.toInt(e.form[utils.getCountName(n.attributeName)]):"Text"!==n.inputType&&"TextArea"!==n.inputType&&"TextEditor"!==n.inputType||0===e.contentId&&(e.form[utils.toCamelCase(n.attributeName)]=n.defaultValue)}setTimeout(function(){for(var t=0;t<e.styles.length;t++){var s=e.styles[t];if("TextEditor"===s.inputType){var i=utils.getEditor(s.attributeName,s.height);i.styleIndex=t,i.ready(function(){this.addListener("contentChange",function(){var t=e.styles[this.styleIndex];e.form[utils.toCamelCase(t.attributeName)]=this.getContent()})})}}},100)}).catch(function(e){utils.error(e)}).then(function(){utils.loading(e,!1)})},apiInsert:function(){var e=this;utils.loading(this,!0),$api.csrfPost(this.csrfToken,$urlInsert,{siteId:this.siteId,channelId:this.channelId,contentId:this.contentId,content:this.form,translates:this.translates,linkTo:this.linkTo,isScheduled:this.scheduledForm.isScheduled,scheduledDate:this.scheduledForm.scheduledDate}).then(function(t){t.data;e.closeAndRedirect(!1)}).catch(function(e){utils.error(e)}).then(function(){utils.loading(e,!1)})},getChannelUrl:function(e){return utils.getRootUrl("redirect",{siteId:this.siteId,channelId:e.value})},getText:function(e,t){for(var s="",i=0;i<this.styles.length;i++){var n=this.styles[i];if("TextEditor"===n.inputType){var l=utils.getEditor(n.attributeName),r=this.regexReplace($regCensor,l.getContent());s+=r=this.regexReplace($regSpell,r)}}var o=[];if(e){for(var a of this.censorSettings.ignoreWords)o.push(a);for(var a of this.censorSettings.whiteListWords)o.push(a)}if(t){for(var a of this.spellSettings.ignoreWords)o.push(a);for(var a of this.spellSettings.whiteListWords)o.push(a)}for(var a of o)s=s.replace(new RegExp(a,"g"),"");return s},parseText:function(){for(var e=0;e<this.styles.length;e++){var t=this.styles[e];if("TextEditor"===t.inputType){var s=utils.getEditor(t.attributeName),i=this.regexReplace($regCensor,s.getContent());if(i=this.regexReplace($regSpell,i),this.censorResults&&this.censorResults.badWords&&this.censorResults.badWords.length>0)for(var n of this.censorResults.badWords)for(var l of n.words)i=i.replace(new RegExp(l,"g"),'<a href="javascript:;" _censor="true" _censor_original="'+l+'" style="color: red;  margin-left: 30px; margin-right: 30px; text-decoration: underline;">疑似违规：'+l+"</a>");if(this.spellResults&&this.spellResults.errorWords&&this.spellResults.errorWords.length>0)for(var r of this.spellResults.errorWords)i=i.replace(new RegExp(r.original,"g"),'<a href="javascript:;" _spell="true" _spell_original="'+r.original+'" _spell_correct="'+r.correct+'" style="color: red; margin-left: 30px; margin-right: 30px; text-decoration: underline;">疑似错误：'+r.original+"，系统建议："+(r.correct?r.correct:'<span style="text-decoration: line-through;">删除<span>')+"</a>");s.setContent(i)}}},parse:function(e,t,s){if("censor_delete"===e||"censor_ignore"===e||"censor_whitelist"===e)for(var i of(this.censorResults.isBadWords=!1,this.censorResults.badWords)){-1!==(l=i.words.indexOf(t))&&i.words.splice(l,1),i.words.length>0&&(this.censorResults.isBadWords=!0)}else if("spell_replace"===e||"spell_ignore"===e||"spell_whitelist"===e)for(var n of(this.spellResults.isErrorWords=!1,this.spellResults.errorWords)){if(n.original==t){var l=this.spellResults.errorWords.indexOf(n);this.spellResults.errorWords.splice(l,1)}this.spellResults.errorWords.length>0&&(this.spellResults.isErrorWords=!0)}"censor_ignore"===e?this.censorSettings.ignoreWords.push(t):"censor_whitelist"===e?this.censorSettings.whiteListWords.push(t):"spell_ignore"===e?this.spellSettings.ignoreWords.push(t):"spell_whitelist"===e&&this.spellSettings.whiteListWords.push(t);for(var r=0;r<this.styles.length;r++){var o=this.styles[r];if("TextEditor"===o.inputType){var a=utils.getEditor(o.attributeName),u=this.regexReplace($regCensor,a.getContent());u=this.regexReplace($regSpell,u),"censor_delete"===e?u=u.replace(new RegExp(t,"g"),""):"spell_replace"===e&&(u=u.replace(new RegExp(t,"g"),s)),a.setContent(u)}}this.parseText(),utils.success("操作成功！")},isCensorButton:function(){return this.censorSettings.isCensorText&&!this.censorSettings.isCensorTextAuto},isSpellButton:function(){return this.spellSettings.isSpellingCheck&&!this.spellSettings.isSpellingCheckAuto},apiCloudCensorAddWords:function(e){var t=this;utils.loading(this,!0),this.censorSettings.isCloudCensor?cloud.post($urlCloudCensorAddWords,{isWhiteList:!0,words:e}).then(function(s){s.data;t.parse("censor_whitelist",e)}).catch(function(e){utils.error(e,{ignoreAuth:!0})}).then(function(){utils.loading(t,!1)}):$api.post($urlCensorAddWords,{siteId:this.siteId,channelId:this.channelId,word:e}).then(function(t){t.data;this.parse("censor_whitelist",e)}).catch(function(e){utils.error(e)}).then(function(){utils.loading(t,!1)})},apiCloudCensor:function(e){var t=this;this.censorSettings.isCensorChecking=!0,this.censorSettings.isCloudCensor?cloud.post($urlCloudCensor,{text:this.getText(!0,!1)}).then(function(s){var i=s.data;for(var n of(t.censorResults=_.assign({},i),t.censorSettings.activeNames=[],t.censorResults.badWords))n.words.length>0&&t.censorSettings.activeNames.push(n.type);t.sideType="censor",t.parseText(i),e&&!t.censorResults.isBadWords&&(t.censorSettings.isCensorPassed=!0,t.apiSave())}).catch(function(e){utils.error(e,{ignoreAuth:!0}),layer.closeAll()}).then(function(){t.censorSettings.isCensorChecking=!1}):$api.csrfPost(this.csrfToken,$urlCensor,{siteId:this.siteId,channelId:this.channelId,text:this.getText(!0,!1)}).then(function(s){var i=s.data;for(var n of(t.censorResults=_.assign({},i),t.censorSettings.activeNames=[],t.censorResults.badWords))n.words.length>0&&t.censorSettings.activeNames.push(n.type);t.sideType="censor",t.parseText(i),e&&!t.censorResults.isBadWords&&(t.censorSettings.isCensorPassed=!0,t.apiSave())}).catch(function(e){utils.error(e),layer.closeAll()}).then(function(){t.censorSettings.isCensorChecking=!1})},apiCloudSpellAddWords:function(e){var t=this;utils.loading(this,!0),this.spellSettings.isCloudSpell?cloud.post($urlCloudSpellAddWords,{words:e}).then(function(s){s.data;t.parse("spell_whitelist",e)}).catch(function(e){utils.error(e,{ignoreAuth:!0})}).then(function(){utils.loading(t,!1)}):$api.post($urlSpellAddWords,{siteId:this.siteId,channelId:this.channelId,word:e}).then(function(t){t.data;this.parse("spell_whitelist",e)}).catch(function(e){utils.error(e)}).then(function(){utils.loading(t,!1)})},apiCloudSpell:function(e){var t=this;this.spellSettings.isSpellChecking=!0,this.spellSettings.isCloudSpell?cloud.post($urlCloudSpell,{text:this.getText(!1,!0)}).then(function(s){var i=s.data;t.spellResults=_.assign({},i),t.sideType="spell",t.parseText(i),e&&!t.spellResults.isErrorWords&&(t.spellSettings.isSpellPassed=!0,t.apiSave())}).catch(function(e){utils.error(e,{ignoreAuth:!0}),layer.closeAll()}).then(function(){t.spellSettings.isSpellChecking=!1}):$api.csrfPost(this.csrfToken,$urlSpell,{siteId:this.siteId,channelId:this.channelId,text:this.getText(!1,!0)}).then(function(s){var i=s.data;t.spellResults=_.assign({},i),t.sideType="spell",t.parseText(i),e&&!t.spellResults.isErrorWords&&(t.spellSettings.isSpellPassed=!0,t.apiSave())}).catch(function(e){utils.error(e),layer.closeAll()}).then(function(){t.spellSettings.isSpellChecking=!1})},apiTags:function(){var e=this;utils.loading(this,!0),$api.csrfPost(this.csrfToken,$urlTags,{siteId:this.siteId,channelId:this.channelId,content:this.form.body}).then(function(t){var s=t.data;s.tags&&s.tags.length>0&&(e.form.tagNames=_.union(e.form.tagNames,s.tags),utils.success("成功提取标签！"))}).catch(function(e){utils.error(e)}).then(function(){utils.loading(e,!1)})},apiPreview:function(){var e=this;utils.loading(this,!0),$api.csrfPost(this.csrfToken,$urlPreview,{siteId:this.siteId,channelId:this.channelId,contentId:this.contentId,content:this.form}).then(function(t){var s=t.data;e.isPreviewSaving=!1,window.open(s.url)}).catch(function(e){utils.error(e)}).then(function(){utils.loading(e,!1)})},apiUpdate:function(){var e=this;utils.loading(this,!0),$api.csrfPost(this.csrfToken,$urlUpdate,{siteId:this.siteId,channelId:this.channelId,contentId:this.contentId,content:this.form,translates:this.translates,linkTo:this.linkTo,isScheduled:this.scheduledForm.isScheduled,scheduledDate:this.scheduledForm.scheduledDate}).then(function(t){t.data;e.closeAndRedirect(!0)}).catch(function(e){utils.error(e)}).then(function(){utils.loading(e,!1)})},apiSave:function(){!this.censorSettings.isCensorPassed&&this.censorSettings.isCensorText&&this.censorSettings.isCensorTextAuto?this.btnCensorTextClick(!0):!this.spellSettings.isSpellPassed&&this.spellSettings.isSpellingCheck&&this.spellSettings.isSpellingCheckAuto?this.btnSpellingCheckClick(!0):0===this.contentId?this.apiInsert():this.apiUpdate()},runFormLayerImageUploadText:function(e,t,s){this.insertText(e,t,s)},runFormLayerImageUploadEditor:function(e,t){this.insertEditor(e,t)},runMaterialLayerImageSelect:function(e,t,s){this.insertText(e,t,s)},runFormLayerFileUpload:function(e,t,s){this.insertText(e,t,s)},runMaterialLayerFileSelect:function(e,t,s){this.insertText(e,t,s)},runFormLayerVideoUpload:function(e,t,s,i){this.insertText(e,t,s),i&&this.runFormLayerImageUploadText("ImageUrl",t,i)},runMaterialLayerVideoSelect:function(e,t,s){this.insertText(e,t,s)},runEditorLayerImage:function(e,t){this.insertEditor(e,t)},runLayerContentSelect:function(e){this.linkTo.contentId=e.id,this.linkTo.contentTitle=e.title},getContentUrl:function(){return utils.getRootUrl("redirect",{siteId:this.siteId,channelId:this.linkTo.channelIds[this.linkTo.channelIds.length-1],contentId:this.linkTo.contentId})},insertText:function(e,t,s){(this.form[utils.getCountName(e)]||0)<=t&&(this.form[utils.getCountName(e)]=t),this.form[utils.getExtendName(e,t)]=s,this.form=_.assign({},this.form)},insertEditor:function(e,t){e||(e="Body"),t&&utils.getEditor(e).execCommand("insertHTML",t)},addTranslation:function(e,t,s,i){this.translates.push({siteId:this.siteId,channelId:this.channelId,targetSiteId:e,targetChannelId:t,translateType:s,summary:i})},updateGroups:function(e,t){this.groupNames=e.groupNames,utils.success(t)},syncEditors:function(){var e=this;UE&&$.each(UE.instants,function(t,s){s.sync();var i=e.styles[s.styleIndex],n=e.regexReplace($regCensor,s.getContent());n=e.regexReplace($regSpell,n),e.form[utils.toCamelCase(i.attributeName)]=n})},regexReplace:function(e,t){for(var s=t;null!==(match=e.exec(t));)s=s.replace(match[0],match[1]);return s},closeAndRedirect:function(e){var t=utils.getTabVue(this.tabName);t&&(e?t.apiList(this.reloadChannelId>0?this.reloadChannelId:this.channelId,this.page,"内容编辑成功！"):t.apiList(this.channelId,this.page,"内容新增成功！",!0)),utils.removeTab(),utils.openTab(this.tabName)},btnImageSelectClick:function(e){var t=e.inputType,s=e.attributeName,i=e.no,n=e.type;"uploadedImages"===n?this.btnLayerClick({title:"选择已上传图片",name:"formLayerImageSelect",inputType:t,attributeName:s,no:i,full:!0}):"materialImages"===n?this.btnLayerClick({title:"选择素材库图片",name:"materialLayerImageSelect",inputType:t,attributeName:s,no:i,full:!0}):"cloudImages"===n&&utils.openLayer({title:"选择免版权图库",url:utils.getCloudsUrl("layerImagesSelect",{inputType:t,attributeName:e.attributeName,no:e.no})})},btnLayerClick:function(e){var t={siteId:this.siteId,channelId:this.channelId,editorAttributeName:"Body"};e.contentId&&(t.contentId=e.contentId),e.inputType&&(t.inputType=e.inputType),e.attributeName&&(t.attributeName=e.attributeName),e.no&&(t.no=e.no);var s={title:e.title,url:utils.getCommonUrl(e.name,t)};e.full||(s.width=e.width?e.width:750,s.height=e.height?e.height:550),utils.openLayer(s)},handleTranslationClose:function(e){this.translates=_.remove(this.translates,function(t){return e!==t.summary})},btnSaveCommandClick:function(e){this.isScheduledDialog="scheduled"===e},btnSubmitClick:function(){var e=this;this.syncEditors(),this.$refs.form.validate(function(t){t&&e.$refs.linkToForm.validate(function(t){t&&(e.censorSettings.isCensorPassed=e.spellSettings.isSpellPassed=!1,e.apiSave())})})},btnScheduledSaveClick:function(){var e=this;this.$refs.scheduledForm.validate(function(t){if(t){var s=new Date;if(s.setMinutes(s.getMinutes()+5),!e.scheduledForm.scheduledDate||new Date(e.scheduledForm.scheduledDate).getTime()<s.getTime())return void utils.error("定时发布失败，定时发布时间只能是5分钟之后的某一时刻");e.isScheduledDialog=!1,e.btnSubmitClick()}})},btnSaveClick:function(){this.scheduledForm.isScheduled=!1,this.btnSubmitClick()},btnCensorTextClick:function(e){this.syncEditors(),this.apiCloudCensor(e)},btnSpellingCheckClick:function(e){this.syncEditors(),this.apiCloudSpell(e)},btnTagsClick:function(){this.syncEditors(),this.form.body&&this.apiTags()},btnPreviewClick:function(){var e=this;this.isPreviewSaving||(this.syncEditors(),this.$refs.form.validate(function(t){t?e.apiPreview():utils.error("预览失败，请检查表单值是否正确")}))},btnCloseClick:function(){utils.removeTab()},btnGroupAddClick:function(){utils.openLayer({title:"新增内容组",url:utils.getCommonUrl("groupContentLayerAdd",{siteId:this.siteId}),width:500,height:300})},btnTranslateAddClick:function(){utils.openLayer({title:"选择转移栏目",url:utils.getCmsUrl("editorLayerTranslate",{siteId:this.siteId,channelId:this.channelId}),width:620,height:400})},btnLinkToContentClick:function(){var e=this.linkTo.channelIds[this.linkTo.channelIds.length-1];utils.openLayer({title:"选择指定内容",url:utils.getCmsUrl("layerContentSelect",{siteId:this.siteId,channelId:e,contentId:this.contentId})})},btnExtendAddClick:function(e){var t=this.form[utils.getCountName(e.attributeName)]+1;this.form[utils.getCountName(e.attributeName)]=t,this.form[utils.getExtendName(e.attributeName,t)]="",this.form=_.assign({},this.form)},btnExtendRemoveClick:function(e){var t=this.form[utils.getCountName(e.attributeName)];this.form[utils.getCountName(e.attributeName)]=t-1,this.form[utils.getExtendName(e.attributeName,t)]="",this.form=_.assign({},this.form)},btnExtendPreviewClick:function(e,t){for(var s=this.form[utils.getCountName(e)],i=[],n=0;n<=s;n++){var l=this.form[utils.getExtendName(e,n)];l=utils.getUrl(this.siteUrl,l),i.push({src:l})}layer.photos({photos:{start:t,data:i},anim:5})},btnExtendPreviewVideoClick:function(e){e&&utils.openLayer({title:"预览视频",url:utils.getCommonUrl("editorLayerPreviewVideo",{siteId:this.siteId,videoUrl:e}),width:600,height:500})}},$vue=new Vue({el:"#main",data:data,methods:methods,created:function(){utils.keyPress(this.btnSaveClick,this.btnCloseClick),this.apiGet()}});