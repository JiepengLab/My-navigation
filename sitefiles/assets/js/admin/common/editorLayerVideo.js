var $url="/common/editor/layerVideo",$urlCloud="cms/vod",data=utils.init({attributeName:utils.getQueryString("attributeName"),rootUrl:null,siteUrl:null,isCloudVod:!1,form:{siteId:utils.getQueryInt("siteId"),type:"upload",videoUrl:"",isPoster:!1,isAutoPlay:!1,isWidth:!1,isHeight:!1,imageUrl:"",width:"100%",height:"500px",isLinkToOriginal:!0},uploadVideoUrl:null,uploadImageUrl:null,cloudUploadToken:null,cloudUploadUrl:null,cloudUploadErrorMessage:null,cloudUploadProgressPercent:null,cloudUploadProgressInterval:null}),methods={apiGet:function(){var e=this;utils.loading(this,!0),$api.get($url,{params:{siteId:this.form.siteId}}).then(function(o){var r=o.data;e.rootUrl=r.rootUrl,e.siteUrl=r.siteUrl,e.isCloudVod=r.isCloudVod}).catch(function(e){utils.error(e)}).then(function(){utils.loading(e,!1)})},getPreviewVideoUrl:function(e){return utils.getUrl(this.siteUrl,e)},btnSubmitClick:function(){if(!this.form.videoUrl)return utils.error("请上传需要插入的视频文件！"),!1;var e=this.form.isPoster&&this.form.imageUrl?' imageUrl="'+this.form.imageUrl+'"':"",o=' isAutoPlay="'+this.form.isAutoPlay+'"',r=this.form.isWidth?' width="'+this.form.width+'"':"",t=this.form.isHeight?' height="'+this.form.height+'"':"";parent.$vue.insertEditor(this.attributeName,'<img src="/sitefiles/assets/images/video-clip.png" style="width: 333px; height: 333px"'+e+o+r+t+' playUrl="'+this.form.videoUrl+'" class="siteserver-stl-player" /><br/>'),utils.closeLayer()},btnCancelClick:function(){utils.closeLayer()},uploadVideoBefore:e=>!!/(\.mp4|\.flv|\.f4v|\.webm|\.m4v|\.mov|\.3gp|\.3g2)$/i.exec(e.name)||(utils.error("文件只能是视频格式，请选择有效的文件上传!"),!1),uploadImageBefore:e=>/(\.jpg|\.jpeg|\.bmp|\.gif|\.png|\.webp)$/i.exec(e.name)?!!(e.size/1024/1024<10)||(utils.error("上传图片大小不能超过 10MB!"),!1):(utils.error("文件只能是图片格式，请选择有效的文件上传!"),!1),uploadProgress:function(){utils.loading(this,!0)},uploadVideoSuccess:function(e){this.form.videoUrl=e.url,e.coverUrl&&(this.form.isPoster=!0,this.form.imageUrl=e.coverUrl),this.form.type="url",utils.loading(this,!1)},uploadImageSuccess:function(e){this.form.imageUrl=e.url,utils.loading(this,!1)},uploadError:function(e){utils.loading(this,!1);var o=JSON.parse(e.message);utils.error(o.message)},cloudUploadBefore:function(e){this.cloudUploadErrorMessage="";return!!/(\.3gp|\.asf|\.avi|\.dat|\.dv|\.flv|\.f4v|\.gif|\.m2t|\.m4v|\.mj2|\.mjpeg|\.mkv|\.mov|\.mp4|\.mpe|\.mpg|\.mpeg|\.mts|\.ogg|\.qt|\.rm|\.rmvb|\.swf|\.ts|\.vob|\.wmv|\.webm)$/i.exec(e.name)||(this.cloudUploadErrorMessage="请选择有效的文件上传!",!1)},cloudUploadRequest:function(e){var o=this,r=new FormData;r.append("file",e.file);var t={onUploadProgress:function(e){o.cloudUploadProgressPercent=Number((e.loaded/e.total*30).toFixed(2)),e.loaded===e.total&&(o.cloudUploadProgressInterval=setInterval(function(){o.cloudUploadProgressPercent+=1,99===o.cloudUploadProgressPercent&&clearInterval(o.cloudUploadProgressInterval)},1e3))}};cloud.post(this.cloudUploadUrl,r,t).then(function(e){var r=e.data;o.form.videoUrl=r.playUrl,r.coverUrl&&(o.form.isPoster=!0,o.form.imageUrl=r.coverUrl),o.form.type="url"}).catch(function(e){o.cloudUploadProgressPercent=null,o.cloudUploadErrorMessage=utils.getErrorMessage(e)}).then(function(){clearInterval(o.cloudUploadProgressInterval)})}},$vue=new Vue({el:"#main",data:data,methods:methods,created:function(){utils.keyPress(this.btnSubmitClick,this.btnCancelClick),this.uploadVideoUrl=$apiUrl+$url+"/actions/uploadVideo?siteId="+this.form.siteId,this.uploadImageUrl=$apiUrl+$url+"/actions/uploadImage?siteId="+this.form.siteId,this.cloudUploadToken=$cloudToken,this.cloudUploadUrl=cloud.defaults.baseURL+"/"+$urlCloud,this.apiGet()}});