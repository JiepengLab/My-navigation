var $url="/settings/sitesAdd",$urlUpload=$apiUrl+"/settings/sitesAdd/actions/upload",data=utils.init({pageType:utils.getQueryString("type")||"selectType",siteTemplates:null,rootExists:null,sites:null,tableNameList:null,page:utils.getQueryInt("page",1),word:utils.getQueryString("word"),tag:utils.getQueryString("tag"),price:utils.getQueryString("price"),order:utils.getQueryString("order"),buy:utils.getQueryString("buy"),themes:null,count:null,pages:null,tags:[],orderedGuids:[],parentIds:[0],form:{guid:null,createType:utils.getQueryString("createType"),localDirectoryName:utils.getQueryString("localDirectoryName"),cloudThemeUserName:utils.getQueryString("cloudThemeUserName"),cloudThemeName:utils.getQueryString("cloudThemeName"),isCloudThemeFree:utils.getQueryBoolean("isCloudThemeFree"),siteName:"",root:!1,parentId:0,siteDir:"",tableRule:"Create",tableChoose:"",tableHandWrite:"",isImportContents:!0,isImportTableStyles:!0},total:1,current:0,message:"",success:!1,uploadPanel:!1,uploadLoading:!1,uploadList:[],errorMessage:""}),methods={apiGet:function(){var e=this;$api.get($url).then(function(t){var i=t.data;e.siteTemplates=i.siteTemplates,e.rootExists=i.rootExists,e.sites=i.sites,e.tableNameList=i.tableNameList,e.form.guid=i.guid}).catch(function(t){e.errorMessage=utils.getErrorMessage(t),e.pageType="error"}).then(function(){utils.loading(e,!1),"selectCloud"==e.pageType&&e.load()})},apiSubmit:function(){var e=this,t=setTimeout(function(){e.apiProcess()},3e3);utils.loading(this,!0),this.form.parentId=this.parentIds&&this.parentIds.length>0?this.parentIds[this.parentIds.length-1]:0,$api.post($url,this.form).then(function(t){var i=t.data;e.total=1,e.current=1,e.message="站点创建成功！",e.success=!0,setTimeout(function(){parent.location.href=utils.getIndexUrl({siteId:i.value})},1e3)}).catch(function(i){clearTimeout(t),e.pageType="submit",utils.loading(e,!1),utils.error(i)})},apiProcess:function(){var e=this;e.pageType="process",$api.post($url+"/actions/process",{guid:this.form.guid}).then(function(t){var i=t.data;e.success||(e.total=i.total||1,e.current=i.current,e.message=i.message,e.current>e.total&&(e.current=e.total),e.total>e.current&&setTimeout(function(){e.apiProcess()},3e3),utils.loading(e,!1))}).catch(function(e){utils.error(e)})},getTemplatesUrl:function(){return cloud.host+"/templates/"},getDisplayUrl:function(e,t){return cloud.getThemesUrl("template.html?userName="+e+"&name="+t)},getCoverUrl:function(e){return cloud.hostStorage+"/themes/"+e.userName+"/"+e.name+"/"+_.trim(e.coverUrl,"/")},isCreatable:function(e){return 0===e.price||-1!==this.orderedGuids.indexOf(e.guid)},btnImageClick:function(e){window.open(this.getDisplayUrl(e.userName,e.name))},btnPreviewClick:function(e){window.open(cloud.hostDemo+"/"+e.userName+"/"+e.name+"/")},getPageUrl:function(e){return e<1||e>this.pages||e==this.page?"javascript:;":this.getUrl(e,this.word,this.tag,this.price,this.order)},getTagUrl:function(e){return this.getUrl(this.page,this.word,e,this.price,this.order)},getPriceUrl:function(e){return this.getUrl(this.page,this.word,this.tag,e,this.order)},getOrderUrl:function(e){return this.getUrl(this.page,this.word,this.tag,this.price,e)},btnRedirectClick:function(e){location.href=e},handlePageChange:function(e){location.href=this.getPageUrl(e)},getUrl:function(e,t,i,r,s){var a="?type=selectCloud&page="+e;return t&&(a+="&word="+t),i&&(a+="&tag="+i),r&&(a+="&price="+r),s&&(a+="&order="+s),a},priceChanged:function(){this.load()},orderChanged:function(){this.load()},load:function(){var e=this;utils.loading(this,!0),cloud.getThemes(this.page,this.word,this.tag,this.price,this.order).then(function(t){var i=t.data;if(e.themes=i.themes,e.count=i.count,e.pages=i.pages,e.tags=i.tags,e.orderedGuids=i.orderedGuids,e.buy){var r=e.buy.split(".")[0],s=e.buy.split(".")[1];e.btnBuyClick(r,s)}}).catch(function(e){utils.error(e,{ignoreAuth:!0})}).then(function(){utils.loading(e,!1)})},btnLocalClick:function(){this.pageType="selectLocal",this.form.createType="local"},btnCloudClick:function(){this.pageType="selectCloud",this.form.createType="cloud",this.load()},btnCancelClick:function(){this.pageType="selectType"},btnCreateEmptyClick:function(){this.form.createType="empty",this.pageType="submit"},btnCreateLocalClick:function(e,t){this.form.createType="local",this.form.localDirectoryName=e,this.form.siteName=t,this.pageType="submit"},btnCreateCloudClick:function(e){this.form.createType="cloud",this.form.cloudThemeUserName=e.userName,this.form.cloudThemeName=e.name,this.form.isCloudThemeFree=0===e.price,this.pageType="submit"},getThemeUrl:function(e){return e?cloud.host+"/templates/template.html?userName="+encodeURIComponent(e.userName)+"&name="+encodeURIComponent(e.name):"javascript:;"},btnBuyClick:function(e,t){var i=this,r=utils.addQuery(location.href,{buy:e+"."+t});cloud.checkAuth(function(){utils.openLayer({title:"购买",width:600,height:500,url:cloud.host+"/layer/pay.html?resourceType=Theme&userName="+e+"&name="+t}),window.addEventListener("message",function(e){if(e.origin===cloud.host){var t=e.data.userName,r=e.data.name;t&&r&&(i.btnCreateCloudClick(e.data),window.layer.closeAll())}},!1)},r)},btnSubmitClick:function(){var e=this;this.$refs.form.validate(function(t){t&&e.apiSubmit()})},btnCloseClick:function(){utils.removeTab()},btnUploadClick:function(){this.uploadPanel=!0},uploadBefore(e){var t=-1!==e.name.indexOf(".zip",e.name.length-".zip".length);return t||utils.error("上传站点模板只能是 Zip 格式!"),t},uploadProgress:function(){utils.loading(this,!0)},uploadSuccess:function(e,t){utils.loading(this,!1),this.form.createType="local",this.form.localDirectoryName=e.directoryName,this.pageType="submit",this.uploadPanel=!1,utils.success("站点模板上传成功！")},uploadError:function(e){utils.loading(this,!1);var t=JSON.parse(e.message);utils.error(t.message)}},$vue=new Vue({el:"#main",data:data,methods:methods,created:function(){var e=this;utils.keyPress(function(){"submit"===e.pageType&&e.btnSubmitClick()},function(){"submit"===e.pageType?e.btnCancelClick():e.btnCloseClick()}),this.apiGet()}});