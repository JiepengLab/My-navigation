var $url="/register",$urlCaptcha="/register/captcha",$urlCaptchaCheck="/register/captcha/actions/check",$urlSendSms="/register/actions/sendSms",$urlVerifyMobile="/register/actions/verifyMobile",data=utils.init({returnUrl:decodeURIComponent(utils.getQueryString("returnUrl")),isSmsEnabled:null,isUserVerifyMobile:null,isUserRegistrationMobile:null,isUserRegistrationEmail:null,isUserRegistrationGroup:null,isUserRegistrationDisplayName:null,isUserCaptchaDisabled:!1,isHomeAgreement:null,homeAgreementHtml:null,styles:null,groups:null,settings:null,isAgreement:!1,captchaToken:null,captchaUrl:null,countdown:0,form:{mobile:"",code:"",captchaValue:"",groupId:0}}),methods={runFormLayerImageUploadText:function(t,i,e){this.insertText(t,i,e)},runFormLayerImageUploadEditor:function(t,i){this.insertEditor(t,i)},runMaterialLayerImageSelect:function(t,i,e){this.insertText(t,i,e)},runFormLayerFileUpload:function(t,i,e){this.insertText(t,i,e)},runMaterialLayerFileSelect:function(t,i,e){this.insertText(t,i,e)},runFormLayerVideoUpload:function(t,i,e){this.insertText(t,i,e)},runMaterialLayerVideoSelect:function(t,i,e){this.insertText(t,i,e)},runEditorLayerImage:function(t,i){this.insertEditor(t,i)},insertText:function(t,i,e){(this.form[utils.getCountName(t)]||0)<=i&&(this.form[utils.getCountName(t)]=i),this.form[utils.getExtendName(t,i)]=e,this.form=_.assign({},this.form)},apiGet:function(){var t=this;utils.loading(this,!0),$api.get($url).then(function(i){var e=i.data;t.isSmsEnabled=e.isSmsEnabled,t.isUserVerifyMobile=e.isUserVerifyMobile,t.isUserRegistrationMobile=e.isUserRegistrationMobile,t.isUserRegistrationEmail=e.isUserRegistrationEmail,t.isUserRegistrationGroup=e.isUserRegistrationGroup,t.isUserRegistrationDisplayName=e.isUserRegistrationDisplayName,t.isUserCaptchaDisabled=e.isUserCaptchaDisabled,t.isHomeAgreement=e.isHomeAgreement,t.homeAgreementHtml=e.homeAgreementHtml,t.styles=e.styles;for(var a=0;a<e.styles.length;a++){var r=e.styles[a];t.form[utils.toCamelCase(r.attributeName)]=r.defaultValue}t.form=_.assign({},t.form),t.groups=e.groups,t.settings=e.settings,t.apiCaptchaReload()}).catch(function(t){var i=utils.getErrorMessage(t);utils.error(i,{redirect:!0})}).then(function(){utils.loading(t,!1)})},apiSendSms:function(){var t=this;utils.loading(this,!0),$api.post($urlSendSms,{mobile:this.form.mobile}).then(function(i){i.data;utils.notifySuccess("验证码发送成功，10分钟内有效"),t.countdown=60;var e=setInterval(function(){t.countdown-=1,t.countdown<=0&&clearInterval(e)},1e3)}).catch(function(t){utils.notifyError(t)}).then(function(){utils.loading(t,!1)})},btnImageSelectClick:function(t){var i=t.attributeName,e=t.no,a=t.type;"materialImages"===a?this.btnLayerClick({title:"选择素材库图片",name:"materialLayerImageSelect",attributeName:i,no:e,full:!0}):"cloudImages"===a&&utils.openLayer({title:"选择免版权图库",url:utils.getCloudsUrl("layerImagesSelect",{attributeName:t.attributeName,no:t.no})})},btnLayerClick:function(t){var i={attributeName:t.attributeName};t.no&&(i.no=t.no);var e={title:t.title,url:utils.getCommonUrl(t.name,i)};t.full||(e.width=t.width?t.width:700,e.height=t.height?t.height:500),utils.openLayer(e)},btnExtendAddClick:function(t){var i=this.form[utils.getCountName(t.attributeName)]+1;this.form[utils.getCountName(t.attributeName)]=i,this.form[utils.getExtendName(t.attributeName,i)]="",this.form=_.assign({},this.form)},btnExtendRemoveClick:function(t){var i=this.form[utils.getCountName(t.attributeName)];this.form[utils.getCountName(t.attributeName)]=i-1,this.form[utils.getExtendName(t.attributeName,i)]="",this.form=_.assign({},this.form)},btnExtendPreviewClick:function(t,i){for(var e=this.form[utils.getCountName(t)],a=[],r=0;r<=e;r++){var n=this.form[utils.getExtendName(t,r)];n=utils.getUrl(this.siteUrl,n),a.push({src:n})}layer.photos({photos:{start:i,data:a},anim:5})},btnPreviewClick:function(t,i){var e=i?this.form[utils.getExtendName(t,i)]:this.form[t];window.open(e)},apiCaptchaReload:function(){var t=this;utils.loading(this,!0),$api.post($urlCaptcha).then(function(i){var e=i.data;t.captchaToken=e.value,t.form.captchaValue="",t.captchaUrl=$apiUrl+$urlCaptcha+"?token="+t.captchaToken}).catch(function(t){utils.notifyError(t)}).then(function(){utils.loading(t,!1)})},apiCheckCaptcha:function(){var t=this;utils.loading(this,!0),$api.post($urlCaptchaCheck,{token:this.captchaToken,value:this.form.captchaValue}).then(function(i){t.apiSubmit()}).catch(function(i){t.apiCaptchaReload(),utils.loading(t,!1),utils.notifyError(i)})},apiVerifyMobile:function(){var t=this;utils.loading(this,!0),$api.post($urlVerifyMobile,{mobile:this.form.mobile,code:this.form.code}).then(function(i){t.apiSubmit()}).catch(function(i){utils.loading(t,!1),utils.notifyError(i)})},apiSubmit:function(){var t=this;utils.loading(this,!0);var i=_.assign({},this.form);delete i.captchaValue,delete i.confirmPassword,$api.post($url,i).then(function(i){i.data.value?utils.alertSuccess({title:"恭喜，账号注册成功",button:"进入登录页",callback:function(){location.href=utils.getRootUrl("login",{returnUrl:t.returnUrl})}}):utils.alertSuccess({title:"账号注册成功，请等待管理员审核",button:"进入登录页",callback:function(){location.href=utils.getRootUrl("login",{returnUrl:t.returnUrl})}})}).catch(function(i){t.apiCaptchaReload(),utils.loading(t,!1),utils.notifyError(i)})},isMobile:function(t){return/^1[3-9]\d{9}$/.test(t)},btnSendSmsClick:function(){this.countdown>0||(this.form.mobile?this.isMobile(this.form.mobile)?this.apiSendSms():utils.notifyError("请输入有效的手机号码"):utils.notifyError("手机号码不能为空"))},btnRegisterClick:function(){var t=this;this.$refs.form.validate(function(i){i&&(t.isMobileCode?t.apiVerifyMobile():t.isUserCaptchaDisabled?t.apiSubmit():t.apiCheckCaptcha())})},btnLoginClick:function(){location.href=utils.getRootUrl("login")},validatePass:function(t,i,e){""===i?e(new Error("请再次输入密码")):i!==this.form.password?e(new Error("两次输入密码不一致!")):e()}},$vue=new Vue({el:"#main",data:data,methods:methods,computed:{isMobile:function(){return this.isUserVerifyMobile||this.isUserRegistrationMobile},isMobileCode:function(){return this.isUserVerifyMobile||this.isSmsEnabled&&this.isUserRegistrationMobile}},created:function(){this.apiGet()}});