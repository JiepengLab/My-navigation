var $url="/write/editor",$urlUpdate=$url+"/actions/update",$urlPreview=$url+"/actions/preview";Date.prototype.Format=function(t){var e={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var i in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),e)new RegExp("("+i+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?e[i]:("00"+e[i]).substr((""+e[i]).length)));return t};var data=utils.init({pageType:null,siteId:utils.getQueryInt("siteId"),channelId:utils.getQueryInt("channelId"),contentId:utils.getQueryInt("contentId"),page:utils.getQueryInt("page"),tabName:utils.getQueryString("tabName"),mainHeight:"",sideType:"first",collapseSettings:["checkedLevel","addDate"],isSettings:!0,site:null,siteUrl:null,channel:null,groupNames:null,tagNames:null,checkedLevels:null,siteOptions:null,channelOptions:null,styles:null,relatedFields:null,settings:null,form:null,isPreviewSaving:!1}),methods={apiGet:function(){var t=this;window.onresize=t.winResize,window.onresize(),$api.get($url,{params:{siteId:t.siteId,channelId:t.channelId,contentId:t.contentId}}).then(function(e){var i=e.data;if(i.unauthorized)return t.pageType="Unauthorized",void utils.loading(t,!1);t.site=i.site,t.siteUrl=i.siteUrl,t.channel=i.channel,t.groupNames=i.groupNames,t.tagNames=i.tagNames,t.checkedLevels=i.checkedLevels,t.siteOptions=i.siteOptions,t.channelOptions=i.channelOptions,t.styles=i.styles,t.relatedFields=i.relatedFields,t.settings=i.settings,t.form=_.assign({},i.content),t.form.addDate?t.form.addDate=new Date(t.form.addDate).Format("yyyy-MM-dd hh:mm:ss"):t.form.addDate=(new Date).Format("yyyy-MM-dd hh:mm:ss"),0===t.form.id&&(t.form.checkedLevel=-99),(t.form.top||t.form.recommend||t.form.hot||t.form.color)&&t.collapseSettings.push("attributes"),t.form.groupNames&&t.form.groupNames.length>0?t.collapseSettings.push("groupNames"):t.form.groupNames=[],t.form.tagNames&&t.form.tagNames.length>0?t.collapseSettings.push("tagNames"):t.form.tagNames=[],t.form.linkUrl&&t.collapseSettings.push("linkUrl");for(var n=0;n<t.styles.length;n++){var a=t.styles[n];if("CheckBox"===a.inputType||"SelectMultiple"===a.inputType){var s=t.form[utils.toCamelCase(a.attributeName)];Array.isArray(s)||(t.form[utils.toCamelCase(a.attributeName)]=s?utils.toArray(s):[])}else"Image"===a.inputType||"File"===a.inputType||"Video"===a.inputType?t.form[utils.getCountName(a.attributeName)]=utils.toInt(t.form[utils.getCountName(a.attributeName)]):"Text"!==a.inputType&&"TextArea"!==a.inputType&&"TextEditor"!==a.inputType||0===t.contentId&&(t.form[utils.toCamelCase(a.attributeName)]=a.defaultValue)}setTimeout(function(){for(var e=0;e<t.styles.length;e++){var i=t.styles[e];if("TextEditor"===i.inputType){var n=utils.getEditor(i.attributeName);n.styleIndex=e,n.ready(function(){this.addListener("contentChange",function(){var e=t.styles[this.styleIndex];t.form[utils.toCamelCase(e.attributeName)]=this.getContent()})})}}},100)}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},apiInsert:function(){var t=this;utils.loading(this,!0),$api.post($url,{siteId:this.siteId,channelId:this.channelId,contentId:this.contentId,content:this.form}).then(function(e){e.data;t.closeAndRedirect()}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},apiUpdate:function(){var t=this;utils.loading(this,!0),$api.post($urlUpdate,{siteId:this.siteId,channelId:this.channelId,contentId:this.contentId,content:this.form}).then(function(e){e.data;t.closeAndRedirect()}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},apiPreview:function(){var t=this;utils.loading(this,!0),$api.post($urlPreview,{siteId:this.siteId,channelId:this.channelId,contentId:this.contentId,content:this.form}).then(function(e){var i=e.data;t.isPreviewSaving=!1,window.open(i.url)}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},runFormLayerImageUploadText:function(t,e,i){this.insertText(t,e,i)},runFormLayerImageUploadEditor:function(t,e){this.insertEditor(t,e)},runMaterialLayerImageSelect:function(t,e,i){this.insertText(t,e,i)},runFormLayerFileUpload:function(t,e,i){this.insertText(t,e,i)},runMaterialLayerFileSelect:function(t,e,i){this.insertText(t,e,i)},runFormLayerVideoUpload:function(t,e,i,n){this.insertText(t,e,i),n&&this.runFormLayerImageUploadText("ImageUrl",e,n)},runMaterialLayerVideoSelect:function(t,e,i){this.insertText(t,e,i)},runEditorLayerImage:function(t,e){this.insertEditor(t,e)},insertText:function(t,e,i){(this.form[utils.getCountName(t)]||0)<=e&&(this.form[utils.getCountName(t)]=e),this.form[utils.getExtendName(t,e)]=i,this.form=_.assign({},this.form)},insertEditor:function(t,e){t||(t="Body"),e&&utils.getEditor(t).execCommand("insertHTML",e)},updateGroups:function(t,e){this.groupNames=t.groupNames,utils.success(e)},closeAndRedirect:function(t){if(utils.success("内容保存成功！"),this.tabName){var e=utils.getTabVue(this.tabName);e&&e.apiList(this.page),utils.removeTab(),utils.openTab(this.tabName)}else utils.removeTab(),utils.addTab("稿件管理","/home/write/contents/")},winResize:function(){this.mainHeight=$(window).height()-70+"px"},btnImageSelectClick:function(t){var e=t.inputType,i=t.attributeName,n=t.no,a=t.type;"uploadedImages"===a?this.btnLayerClick({title:"选择已上传图片",name:"formLayerImageSelect",inputType:e,attributeName:i,no:n,full:!0}):"materialImages"===a?this.btnLayerClick({title:"选择素材库图片",name:"materialLayerImageSelect",inputType:e,attributeName:i,no:n,full:!0}):"cloudImages"===a&&utils.openLayer({title:"选择免版权图库",url:utils.getCloudsUrl("layerImagesSelect",{inputType:e,attributeName:t.attributeName,no:t.no})})},btnLayerClick:function(t){var e={siteId:this.siteId,channelId:this.channelId,editorAttributeName:"Body"};t.attributeName&&(e.attributeName=t.attributeName),t.inputType&&(e.inputType=t.inputType),t.contentId&&(e.contentId=t.contentId),t.no&&(e.no=t.no);var i={title:t.title,url:utils.getCommonUrl(t.name,e)};t.full||(i.width=t.width?t.width:750,i.height=t.height?t.height:550),utils.openLayer(i)},btnSaveClick:function(){UE&&$.each(UE.instants,function(t,e){e.sync()});var t=this;this.$refs.form.validate(function(e){e&&(0===t.contentId?t.apiInsert():t.apiUpdate())})},syncEditors:function(){var t=this;UE&&$.each(UE.instants,function(e,i){i.sync();var n=t.styles[i.styleIndex];t.form[utils.toCamelCase(n.attributeName)]=i.getContent()})},btnPreviewClick:function(){var t=this;this.isPreviewSaving||(this.syncEditors(),this.$refs.form.validate(function(e){e?t.apiPreview():utils.error("预览失败，请检查表单值是否正确")}))},btnCloseClick:function(){utils.removeTab()},btnExtendAddClick:function(t){var e=this.form[utils.getCountName(t.attributeName)]+1;this.form[utils.getCountName(t.attributeName)]=e,this.form[utils.getExtendName(t.attributeName,e)]="",this.form=_.assign({},this.form)},btnExtendRemoveClick:function(t){var e=this.form[utils.getCountName(t.attributeName)];this.form[utils.getCountName(t.attributeName)]=e-1,this.form[utils.getExtendName(t.attributeName,e)]="",this.form=_.assign({},this.form)},btnExtendPreviewClick:function(t,e){for(var i=this.form[utils.getCountName(t)],n=[],a=0;a<=i;a++){var s=this.form[utils.getExtendName(t,a)];s=utils.getUrl(this.siteUrl,s),n.push({src:s})}layer.photos({photos:{start:e,data:n},anim:5})},btnExtendPreviewVideoClick:function(t){t&&utils.openLayer({title:"预览视频",url:utils.getCommonUrl("editorLayerPreviewVideo",{siteId:this.siteId,videoUrl:t}),width:600,height:500})}},$vue=new Vue({el:"#main",data:data,methods:methods,created:function(){this.apiGet()}});