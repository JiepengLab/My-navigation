define("echarts/chart/pie",["require","./base","zrender/shape/Text","zrender/shape/Ring","zrender/shape/Circle","zrender/shape/Sector","zrender/shape/Polyline","../config","../util/ecData","zrender/tool/util","zrender/tool/math","zrender/tool/color","../chart"],function(e){function t(e,t,i,l,a){s.call(this,e,t,i,l,a);var r=this;r.shapeHandler.onmouseover=function(e){var t=e.target,s=o.get(t,"seriesIndex"),i=o.get(t,"dataIndex"),l=o.get(t,"special"),a=[t.style.x,t.style.y],n=t.style.startAngle,h=t.style.endAngle,d=((h+n)/2+360)%360,c=t.highlightStyle.color,y=r.getLabel(s,i,l,a,d,c,!0);y&&r.zr.addHoverShape(y);var p=r.getLabelLine(s,i,a,t.style.r0,t.style.r,d,c,!0);p&&r.zr.addHoverShape(p)},this.refresh(l)}var s=e("./base"),i=e("zrender/shape/Text"),l=e("zrender/shape/Ring"),a=e("zrender/shape/Circle"),r=e("zrender/shape/Sector"),n=e("zrender/shape/Polyline"),h=e("../config");h.pie={zlevel:0,z:2,clickable:!0,legendHoverLink:!0,center:["50%","50%"],radius:[0,"75%"],clockWise:!0,startAngle:90,minAngle:0,selectedOffset:10,itemStyle:{normal:{borderColor:"rgba(0,0,0,0)",borderWidth:1,label:{show:!0,position:"outer"},labelLine:{show:!0,length:20,lineStyle:{width:1,type:"solid"}}},emphasis:{borderColor:"rgba(0,0,0,0)",borderWidth:1,label:{show:!1},labelLine:{show:!1,length:20,lineStyle:{width:1,type:"solid"}}}}};var o=e("../util/ecData"),d=e("zrender/tool/util"),c=e("zrender/tool/math"),y=e("zrender/tool/color");return t.prototype={type:h.CHART_TYPE_PIE,_buildShape:function(){var e=this.series,t=this.component.legend;this.selectedMap={},this._selected={};var s,i,r;this._selectedMode=!1;for(var n,d=0,c=e.length;c>d;d++)if(e[d].type===h.CHART_TYPE_PIE){if(e[d]=this.reformOption(e[d]),this.legendHoverLink=e[d].legendHoverLink||this.legendHoverLink,n=e[d].name||"",this.selectedMap[n]=!t||t.isSelected(n),!this.selectedMap[n])continue;s=this.parseCenter(this.zr,e[d].center),i=this.parseRadius(this.zr,e[d].radius),this._selectedMode=this._selectedMode||e[d].selectedMode,this._selected[d]=[],this.deepQuery([e[d],this.option],"calculable")&&(r={zlevel:e[d].zlevel,z:e[d].z,hoverable:!1,style:{x:s[0],y:s[1],r0:i[0]<=10?0:i[0]-10,r:i[1]+10,brushType:"stroke",lineWidth:1,strokeColor:e[d].calculableHolderColor||this.ecTheme.calculableHolderColor||h.calculableHolderColor}},o.pack(r,e[d],d,void 0,-1),this.setCalculable(r),r=i[0]<=10?new a(r):new l(r),this.shapeList.push(r)),this._buildSinglePie(d),this.buildMark(d)}this.addShapeList()},_buildSinglePie:function(e){for(var t,s=this.series,i=s[e],l=i.data,a=this.component.legend,r=0,n=0,h=0,o=Number.NEGATIVE_INFINITY,d=[],c=0,y=l.length;y>c;c++)t=l[c].name,this.selectedMap[t]=!a||a.isSelected(t),this.selectedMap[t]&&!isNaN(l[c].value)&&(0!=+l[c].value?r++:n++,h+=+l[c].value,o=Math.max(o,+l[c].value));if(0!==h){for(var p,u,_,g,b,f,m=100,L=i.clockWise,v=(i.startAngle.toFixed(2)-0+360)%360,x=i.minAngle||.01,z=360-x*r-.01*n,S=i.roseType,c=0,y=l.length;y>c;c++)if(t=l[c].name,this.selectedMap[t]&&!isNaN(l[c].value)){if(u=a?a.getColor(t):this.zr.getColor(c),m=l[c].value/h,p="area"!=S?L?v-m*z-(0!==m?x:.01):m*z+v+(0!==m?x:.01):L?v-360/y:360/y+v,p=p.toFixed(2)-0,m=(100*m).toFixed(2),_=this.parseCenter(this.zr,i.center),g=this.parseRadius(this.zr,i.radius),b=+g[0],f=+g[1],"radius"===S?f=l[c].value/o*(f-b)*.8+.2*(f-b)+b:"area"===S&&(f=Math.sqrt(l[c].value/o)*(f-b)+b),L){var C;C=v,v=p,p=C}this._buildItem(d,e,c,m,l[c].selected,_,b,f,v,p,u),L||(v=p)}this._autoLabelLayout(d,_,f);for(var c=0,y=d.length;y>c;c++)this.shapeList.push(d[c]);d=null}},_buildItem:function(e,t,s,i,l,a,r,n,h,d,c){var y=this.series,p=((d+h)/2+360)%360,u=this.getSector(t,s,i,l,a,r,n,h,d,c);o.pack(u,y[t],t,y[t].data[s],s,y[t].data[s].name,i),e.push(u);var _=this.getLabel(t,s,i,a,p,c,!1),g=this.getLabelLine(t,s,a,r,n,p,c,!1);g&&(o.pack(g,y[t],t,y[t].data[s],s,y[t].data[s].name,i),e.push(g)),_&&(o.pack(_,y[t],t,y[t].data[s],s,y[t].data[s].name,i),_._labelLine=g,e.push(_))},getSector:function(e,t,s,i,l,a,n,h,o,d){var p=this.series,u=p[e],_=u.data[t],g=[_,u],b=this.deepMerge(g,"itemStyle.normal")||{},f=this.deepMerge(g,"itemStyle.emphasis")||{},m=this.getItemStyleColor(b.color,e,t,_)||d,L=this.getItemStyleColor(f.color,e,t,_)||("string"==typeof m?y.lift(m,-.2):m),v={zlevel:u.zlevel,z:u.z,clickable:this.deepQuery(g,"clickable"),style:{x:l[0],y:l[1],r0:a,r:n,startAngle:h,endAngle:o,brushType:"both",color:m,lineWidth:b.borderWidth,strokeColor:b.borderColor,lineJoin:"round"},highlightStyle:{color:L,lineWidth:f.borderWidth,strokeColor:f.borderColor,lineJoin:"round"},_seriesIndex:e,_dataIndex:t};if(i){var x=((v.style.startAngle+v.style.endAngle)/2).toFixed(2)-0;v.style._hasSelected=!0,v.style._x=v.style.x,v.style._y=v.style.y;var z=this.query(u,"selectedOffset");v.style.x+=c.cos(x,!0)*z,v.style.y-=c.sin(x,!0)*z,this._selected[e][t]=!0}else this._selected[e][t]=!1;return this._selectedMode&&(v.onclick=this.shapeHandler.onclick),this.deepQuery([_,u,this.option],"calculable")&&(this.setCalculable(v),v.draggable=!0),(this._needLabel(u,_,!0)||this._needLabelLine(u,_,!0))&&(v.onmouseover=this.shapeHandler.onmouseover),v=new r(v)},getLabel:function(e,t,s,l,a,r,n){var h=this.series,o=h[e],y=o.data[t];if(this._needLabel(o,y,n)){var p,u,_,g=n?"emphasis":"normal",b=d.merge(d.clone(y.itemStyle)||{},o.itemStyle),f=b[g].label,m=f.textStyle||{},L=l[0],v=l[1],x=this.parseRadius(this.zr,o.radius);f.position=f.position||b.normal.label.position,"center"===f.position?(p=L,u=v,_="center"):"inner"===f.position||"inside"===f.position?(x=(x[0]+x[1])*(f.distance||.5),p=Math.round(L+x*c.cos(a,!0)),u=Math.round(v-x*c.sin(a,!0)),r="#fff",_="center"):(x=x[1]- -b[g].labelLine.length,p=Math.round(L+x*c.cos(a,!0)),u=Math.round(v-x*c.sin(a,!0)),_=a>=90&&270>=a?"right":"left"),"center"!=f.position&&"inner"!=f.position&&"inside"!=f.position&&(p+="left"===_?20:-20),y.__labelX=p-("left"===_?5:-5),y.__labelY=u;var z=new i({zlevel:o.zlevel,z:o.z+1,hoverable:!1,style:{x:p,y:u,color:m.color||r,text:this.getLabelText(e,t,s,g),textAlign:m.align||_,textBaseline:m.baseline||"middle",textFont:this.getFont(m)},highlightStyle:{brushType:"fill"}});return z._radius=x,z._labelPosition=f.position||"outer",z._rect=z.getRect(z.style),z._seriesIndex=e,z._dataIndex=t,z}},getLabelText:function(e,t,s,i){var l=this.series,a=l[e],r=a.data[t],n=this.deepQuery([r,a],"itemStyle."+i+".label.formatter");return n?"function"==typeof n?n.call(this.myChart,{seriesIndex:e,seriesName:a.name||"",series:a,dataIndex:t,data:r,name:r.name,value:r.value,percent:s}):"string"==typeof n?(n=n.replace("{a}","{a0}").replace("{b}","{b0}").replace("{c}","{c0}").replace("{d}","{d0}"),n=n.replace("{a0}",a.name).replace("{b0}",r.name).replace("{c0}",r.value).replace("{d0}",s)):void 0:r.name},getLabelLine:function(e,t,s,i,l,a,r,h){var o=this.series,y=o[e],p=y.data[t];if(this._needLabelLine(y,p,h)){var u=h?"emphasis":"normal",_=d.merge(d.clone(p.itemStyle)||{},y.itemStyle),g=_[u].labelLine,b=g.lineStyle||{},f=s[0],m=s[1],L=l,v=this.parseRadius(this.zr,y.radius)[1]- -g.length,x=c.cos(a,!0),z=c.sin(a,!0);return new n({zlevel:y.zlevel,z:y.z+1,hoverable:!1,style:{pointList:[[f+L*x,m-L*z],[f+v*x,m-v*z],[p.__labelX,p.__labelY]],strokeColor:b.color||r,lineType:b.type,lineWidth:b.width},_seriesIndex:e,_dataIndex:t})}},_needLabel:function(e,t,s){return this.deepQuery([t,e],"itemStyle."+(s?"emphasis":"normal")+".label.show")},_needLabelLine:function(e,t,s){return this.deepQuery([t,e],"itemStyle."+(s?"emphasis":"normal")+".labelLine.show")},_autoLabelLayout:function(e,t,s){for(var i=[],l=[],a=0,r=e.length;r>a;a++)("outer"===e[a]._labelPosition||"outside"===e[a]._labelPosition)&&(e[a]._rect._y=e[a]._rect.y,e[a]._rect.x<t[0]?i.push(e[a]):l.push(e[a]));this._layoutCalculate(i,t,s,-1),this._layoutCalculate(l,t,s,1)},_layoutCalculate:function(e,t,s,i){function l(t,s){for(var i=t;i>=0&&(e[i]._rect.y-=s,e[i].style.y-=s,e[i]._labelLine&&(e[i]._labelLine.style.pointList[1][1]-=s,e[i]._labelLine.style.pointList[2][1]-=s),!(i>0&&e[i]._rect.y>e[i-1]._rect.y+e[i-1]._rect.height));i--);}function a(e,t,s,i,l){for(var a,r,n,h=s[0],o=s[1],d=t?Number.MAX_VALUE:0,c=0,y=e.length;y>c;c++)r=Math.abs(e[c]._rect.y-o),n=e[c]._radius-i,a=i+n>r?Math.sqrt((i+n+20)*(i+n+20)-Math.pow(e[c]._rect.y-o,2)):Math.abs(e[c]._rect.x+(l>0?0:e[c]._rect.width)-h),t&&a>=d&&(a=d-10),!t&&d>=a&&(a=d+10),e[c]._rect.x=e[c].style.x=h+a*l,e[c]._labelLine&&(e[c]._labelLine.style.pointList[2][0]=h+(a-5)*l,e[c]._labelLine.style.pointList[1][0]=h+(a-20)*l),d=a}e.sort(function(e,t){return e._rect.y-t._rect.y});for(var r,n=0,h=e.length,o=[],d=[],c=0;h>c;c++)r=e[c]._rect.y-n,0>r&&function(t,s,i){for(var a=t;s>a;a++)if(e[a]._rect.y+=i,e[a].style.y+=i,e[a]._labelLine&&(e[a]._labelLine.style.pointList[1][1]+=i,e[a]._labelLine.style.pointList[2][1]+=i),a>t&&s>a+1&&e[a+1]._rect.y>e[a]._rect.y+e[a]._rect.height)return void l(a,i/2);l(s-1,i/2)}(c,h,-r),n=e[c]._rect.y+e[c]._rect.height;this.zr.getHeight()-n<0&&l(h-1,n-this.zr.getHeight());for(var c=0;h>c;c++)e[c]._rect.y>=t[1]?d.push(e[c]):o.push(e[c]);a(d,!0,t,s,i),a(o,!1,t,s,i)},reformOption:function(e){var t=d.merge;return e=t(t(e||{},d.clone(this.ecTheme.pie||{})),d.clone(h.pie)),e.itemStyle.normal.label.textStyle=this.getTextStyle(e.itemStyle.normal.label.textStyle),e.itemStyle.emphasis.label.textStyle=this.getTextStyle(e.itemStyle.emphasis.label.textStyle),this.z=e.z,this.zlevel=e.zlevel,e},refresh:function(e){e&&(this.option=e,this.series=e.series),this.backupShapeList(),this._buildShape()},addDataAnimation:function(e,t){function s(){0===--n&&t&&t()}for(var i=this.series,l={},a=0,r=e.length;r>a;a++)l[e[a][0]]=e[a];var n=0,o={},d={},c={},y=this.shapeList;this.shapeList=[];for(var p,u,_,g={},a=0,r=e.length;r>a;a++)p=e[a][0],u=e[a][2],_=e[a][3],i[p]&&i[p].type===h.CHART_TYPE_PIE&&(u?(_||(o[p+"_"+i[p].data.length]="delete"),g[p]=1):_?g[p]=0:(o[p+"_-1"]="delete",g[p]=-1),this._buildSinglePie(p));for(var b,f,a=0,r=this.shapeList.length;r>a;a++)switch(p=this.shapeList[a]._seriesIndex,b=this.shapeList[a]._dataIndex,f=p+"_"+b,this.shapeList[a].type){case"sector":o[f]=this.shapeList[a];break;case"text":d[f]=this.shapeList[a];break;case"polyline":c[f]=this.shapeList[a]}this.shapeList=[];for(var m,a=0,r=y.length;r>a;a++)if(p=y[a]._seriesIndex,l[p]){if(b=y[a]._dataIndex+g[p],f=p+"_"+b,!(m=o[f]))continue;if("sector"===y[a].type)"delete"!=m?(n++,this.zr.animate(y[a].id,"style").when(400,{startAngle:m.style.startAngle,endAngle:m.style.endAngle}).done(s).start()):(n++,this.zr.animate(y[a].id,"style").when(400,g[p]<0?{startAngle:y[a].style.startAngle}:{endAngle:y[a].style.endAngle}).done(s).start());else if("text"===y[a].type||"polyline"===y[a].type)if("delete"===m)this.zr.delShape(y[a].id);else switch(y[a].type){case"text":n++,m=d[f],this.zr.animate(y[a].id,"style").when(400,{x:m.style.x,y:m.style.y}).done(s).start();break;case"polyline":n++,m=c[f],this.zr.animate(y[a].id,"style").when(400,{pointList:m.style.pointList}).done(s).start()}}this.shapeList=y,n||t&&t()},onclick:function(e){var t=this.series;if(this.isClick&&e.target){this.isClick=!1;for(var s,i=e.target,l=i.style,a=o.get(i,"seriesIndex"),r=o.get(i,"dataIndex"),n=0,d=this.shapeList.length;d>n;n++)if(this.shapeList[n].id===i.id){if(a=o.get(i,"seriesIndex"),r=o.get(i,"dataIndex"),l._hasSelected)i.style.x=i.style._x,i.style.y=i.style._y,i.style._hasSelected=!1,this._selected[a][r]=!1;else{var y=((l.startAngle+l.endAngle)/2).toFixed(2)-0;i.style._hasSelected=!0,this._selected[a][r]=!0,i.style._x=i.style.x,i.style._y=i.style.y,s=this.query(t[a],"selectedOffset"),i.style.x+=c.cos(y,!0)*s,i.style.y-=c.sin(y,!0)*s}this.zr.modShape(i.id)}else this.shapeList[n].style._hasSelected&&"single"===this._selectedMode&&(a=o.get(this.shapeList[n],"seriesIndex"),r=o.get(this.shapeList[n],"dataIndex"),this.shapeList[n].style.x=this.shapeList[n].style._x,this.shapeList[n].style.y=this.shapeList[n].style._y,this.shapeList[n].style._hasSelected=!1,this._selected[a][r]=!1,this.zr.modShape(this.shapeList[n].id));this.messageCenter.dispatch(h.EVENT.PIE_SELECTED,e.event,{selected:this._selected,target:o.get(i,"name")},this.myChart),this.zr.refreshNextFrame()}}},d.inherits(t,s),e("../chart").define("pie",t),t});