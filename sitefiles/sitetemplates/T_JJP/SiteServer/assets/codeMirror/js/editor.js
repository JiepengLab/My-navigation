function makeWhiteSpace(e){for(var t=[],n=!0;e>0;e--)t.push(n||1==e?nbsp:" "),n=!n;return t.join("")}function fixSpaces(e){return" "==e.charAt(0)&&(e=nbsp+e.slice(1)),e.replace(/\t/g,function(){return makeWhiteSpace(indentUnit)}).replace(/[ \u00a0]{2,}/g,function(e){return makeWhiteSpace(e.length)})}function cleanText(e){return e.replace(/\u00a0/g," ").replace(/\u200b/g,"")}function makePartSpan(e,t){var n=e;3==e.nodeType?n=e.nodeValue:e=t.createTextNode(n);var i=t.createElement("SPAN");return i.isPart=!0,i.appendChild(e),i.currentText=n,i}var webkitLastLineHack=webkit?function(e){var t=e.lastChild;t&&t.isPart&&"​"==t.textContent||e.appendChild(makePartSpan("​",e.ownerDocument))}:function(){},Editor=function(){function e(e){var t=makeWhiteSpace(indentUnit);return map(e.replace(/\t/g,t).replace(/\u00a0/g," ").replace(/\r\n?/g,"\n").split("\n"),fixSpaces)}function t(e){function t(e){if(3==e.nodeType){(e.nodeValue=fixSpaces(e.nodeValue.replace(/[\r\u200b]/g,"").replace(/\n/g," "))).length&&(r=!1),i.push(e)}else"BR"==e.nodeName&&0==e.childNodes.length?(r=!0,i.push(e)):(forEach(e.childNodes,t),!r&&l.hasOwnProperty(e.nodeName)&&(r=!0,i.push(n.createElement("BR"))))}var n=e.ownerDocument,i=[],r=!0;return t(e),i}function n(e){function n(e,t){return l=t,e}function i(e,t,n){return function(){return e(t,n)}}function r(){throw l=r,StopIteration}function o(e){var t=e.parentNode,n=e.nextSibling;return function(e){t.insertBefore(e,n)}}function s(e){var t="\n";return 3==e.nodeType&&(select.snapshotChanged(),e=makePartSpan(e,d),t=e.currentText),e.dirty=!0,u.push(e),f(e),t}function a(e,i){var r=[];return forEach(t(e),function(e){r.push(s(e))}),n(r.join(""),i)}function c(e){return!(!e.isPart||1!=e.childNodes.length||3!=e.firstChild.nodeType)&&(e.currentText=e.firstChild.nodeValue,!/[\n\t\r]/.test(e.currentText))}function h(e,t){return e.nextSibling&&(t=i(h,e.nextSibling,t)),c(e)?(u.push(e),n(e.currentText,t)):"BR"==e.nodeName?(u.push(e),n("\n",t)):(f=o(e),removeElement(e),a(e,t))}var l=i(h,e,r),d=e.ownerDocument,u=[],f=null;return{next:function(){return l()},nodes:u}}function i(e){for(;e&&"BR"!=e.nodeName;)e=e.previousSibling;return e}function r(e,t){for(e?"BR"==e.nodeName&&(e=e.nextSibling):e=t.firstChild;e&&"BR"!=e.nodeName;)e=e.nextSibling;return e}function o(){return(new Date).getTime()}function s(e,t,i){var r=select.selectionTopNode(e,!0),o=e.ownerDocument;if(null!=t&&t.parentNode!=e&&(t=i),!1===t&&(t=null),t!=r&&r&&e.firstChild){for(var s=n(t?t.nextSibling:e.firstChild);r.parentNode==e;)try{s.next()}catch(e){break}forEach(s.nodes,function(t){var n="BR"==t.nodeName?o.createElement("BR"):makePartSpan(t.currentText,o);e.replaceChild(n,t)})}}function a(e,t,n){this.editor=e,this.history=e.history,this.history.commit(),this.atOccurrence=!1,this.fallbackSize=15;var i;n&&(i=select.cursorPos(this.editor.container))?(this.line=i.node,this.offset=i.offset):(this.line=null,this.offset=0),this.valid=!!t;var r=t.split("\n"),o=this;this.matches=1==r.length?function(){var e=cleanText(o.history.textAfter(o.line).slice(o.offset)).indexOf(t);if(e>-1)return{from:{node:o.line,offset:o.offset+e},to:{node:o.line,offset:o.offset+e+t.length}}}:function(){var e=cleanText(o.history.textAfter(o.line).slice(o.offset)),t=e.lastIndexOf(r[0]);if(-1==t||t!=e.length-r[0].length)return!1;for(var n=o.offset+t,i=o.history.nodeAfter(o.line),s=1;s<r.length-1;s++){if(cleanText(o.history.textAfter(i))!=r[s])return!1;i=o.history.nodeAfter(i)}return 0==cleanText(o.history.textAfter(i)).indexOf(r[r.length-1])&&{from:{node:o.line,offset:n},to:{node:i,offset:r[r.length-1].length}}}}function c(e){function t(){void 0!=document.body.contentEditable&&internetExplorer?document.body.contentEditable="true":document.designMode="on",document.documentElement.style.borderWidth="0",e.textWrapping||(i.style.whiteSpace="nowrap")}function n(){r.cursorActivity(!1)}this.options=e,window.indentUnit=e.indentUnit,this.parent=parent,this.doc=document;var i=this.container=this.doc.body;this.win=window,this.history=new History(i,e.undoDepth,e.undoDelay,this,e.onChange);var r=this;if(!c.Parser)throw"No parser loaded.";if(e.parserConfig&&c.Parser.configure&&c.Parser.configure(e.parserConfig),e.readOnly||select.setCursorPos(i,{node:null,offset:0}),this.dirty=[],e.content?this.importCode(e.content):i.appendChild(this.doc.createElement("BR")),e.readOnly)e.textWrapping||(i.style.whiteSpace="nowrap");else{!1!==e.continuousScanning&&(this.scanner=this.documentScanner(e.passTime),this.delayScanning());try{t()}catch(e){var o=addEventHandler(document,"focus",function(){o(),t()},!0)}addEventHandler(document,"keydown",method(this,"keyDown")),addEventHandler(document,"keypress",method(this,"keyPress")),addEventHandler(document,"keyup",method(this,"keyUp")),addEventHandler(document.body,"mouseup",n),addEventHandler(document.body,"paste",function(e){if(n(),internetExplorer){var t=null;try{t=window.clipboardData.getData("Text")}catch(e){}if(null!=t)r.replaceSelection(t),e.stop();else{var i=select.selectionTopNode(r.container,!0),o=i&&i.previousSibling;setTimeout(function(){s(r.container,i,o)},0)}}}),addEventHandler(document.body,"cut",n),this.options.autoMatchParens&&addEventHandler(document.body,"click",method(this,"scheduleParenBlink"))}}function h(e){return e>=16&&e<=18||e>=33&&e<=40}var l={P:!0,DIV:!0,LI:!0};return a.prototype={findNext:function(){if(!this.valid)return!1;this.atOccurrence=!1;var e=this;for(this.line&&!this.line.parentNode&&(this.line=null,this.offset=0);;){var t=this.matches();if(t)return this.atOccurrence=t,function(t){e.history.textAfter(t.node).length<t.offset?(e.line=t.node,e.offset=t.offset+1):(e.line=e.history.nodeAfter(t.node),e.offset=0)}(t.from),!0;if(this.line=this.history.nodeAfter(this.line),this.offset=0,!this.line)return this.valid=!1,!1}},select:function(){this.atOccurrence&&(select.setCursorPos(this.editor.container,this.atOccurrence.from,this.atOccurrence.to),select.scrollToCursor(this.editor.container))},replace:function(e){if(this.atOccurrence){var t=this.editor.replaceRange(this.atOccurrence.from,this.atOccurrence.to,e);this.line=t.node,this.offset=t.offset,this.atOccurrence=!1}}},c.prototype={toggleWrapping:function(){"nowrap"==this.container.style.whiteSpace?this.container.style.whiteSpace="":this.container.style.whiteSpace="nowrap"},importCode:function(t){this.history.push(null,null,e(t)),this.history.reset()},getCode:function(){if(!this.container.firstChild)return"";var e=[];return select.markSelection(this.win),forEach(n(this.container.firstChild),method(e,"push")),webkitLastLineHack(this.container),select.selectMarked(),cleanText(e.join(""))},checkLine:function(e){if(!1===e||null!=e&&e.parentNode!=this.container)throw parent.CodeMirror.InvalidLineHandle},cursorPosition:function(e){null==e&&(e=!0);var t=select.cursorPos(this.container,e);return t?{line:t.node,character:t.offset}:{line:null,character:0}},firstLine:function(){return null},lastLine:function(){return this.container.lastChild?i(this.container.lastChild):null},nextLine:function(e){return this.checkLine(e),r(e,this.container)||!1},prevLine:function(e){return this.checkLine(e),null!=e&&i(e.previousSibling)},selectLines:function(e,t,n,i){this.checkLine(e);var r={node:e,offset:t},o=null;void 0!==i&&(this.checkLine(n),o={node:n,offset:i}),select.setCursorPos(this.container,r,o),select.scrollToCursor(this.container)},lineContent:function(e){this.checkLine(e);var t=[];for(e=e?e.nextSibling:this.container.firstChild;e&&"BR"!=e.nodeName;e=e.nextSibling)t.push(nodeText(e));return cleanText(t.join(""))},setLineContent:function(e,t){this.history.commit(),this.replaceRange({node:e,offset:0},{node:e,offset:this.history.textAfter(e).length},t),this.addDirtyNode(e),this.scheduleHighlight()},insertIntoLine:function(t,n,i){var o=null;if("end"==n)o=r(t,this.container);else for(var s=t?t.nextSibling:this.container.firstChild;s;s=s.nextSibling){if(0==n){o=s;break}var a=s.innerText||s.textContent||s.nodeValue||"";if(a.length>n){o=s.nextSibling,i=a.slice(0,n)+i+a.slice(n),removeElement(s);break}n-=a.length}for(var c=e(i),h=this.container.ownerDocument,l=0;l<c.length;l++)l>0&&this.container.insertBefore(h.createElement("BR"),o),this.container.insertBefore(makePartSpan(c[l],h),o);this.addDirtyNode(t),this.scheduleHighlight()},selectedText:function(){var e=this.history;e.commit();var t=select.cursorPos(this.container,!0),n=select.cursorPos(this.container,!1);if(!t||!n)return"";if(t.node==n.node)return e.textAfter(t.node).slice(t.offset,n.offset);for(var i=[e.textAfter(t.node).slice(t.offset)],r=e.nodeAfter(t.node);r!=n.node;r=e.nodeAfter(r))i.push(e.textAfter(r));return i.push(e.textAfter(n.node).slice(0,n.offset)),cleanText(i.join("\n"))},replaceSelection:function(e){this.history.commit();var t=select.cursorPos(this.container,!0),n=select.cursorPos(this.container,!1);t&&n&&(n=this.replaceRange(t,n,e),select.setCursorPos(this.container,t,n))},replaceRange:function(t,n,i){var r=e(i);r[0]=this.history.textAfter(t.node).slice(0,t.offset)+r[0];var o=r[r.length-1];r[r.length-1]=o+this.history.textAfter(n.node).slice(n.offset);var s=this.history.nodeAfter(n.node);return this.history.push(t.node,s,r),{node:this.history.nodeBefore(s),offset:o.length}},getSearchCursor:function(e,t){return new a(this,e,t)},reindent:function(){this.container.firstChild&&this.indentRegion(null,this.container.lastChild)},reindentSelection:function(e){if(select.somethingSelected(this.win)){var t=select.selectionTopNode(this.container,!0),n=select.selectionTopNode(this.container,!1);if(!1===t||!1===n)return;this.indentRegion(t,n,e)}else this.indentAtCursor(e)},grabKeys:function(e,t){this.frozen=e,this.keyFilter=t},ungrabKeys:function(){this.frozen="leave",this.keyFilter=null},setParser:function(e){c.Parser=window[e],this.container.firstChild&&(forEach(this.container.childNodes,function(e){3!=e.nodeType&&(e.dirty=!0)}),this.addDirtyNode(this.firstChild),this.scheduleHighlight())},keyDown:function(e){if("leave"==this.frozen&&(this.frozen=null),this.frozen&&(!this.keyFilter||this.keyFilter(e.keyCode)))return e.stop(),void this.frozen(e);var t=e.keyCode;if(this.delayScanning(),this.options.autoMatchParens&&this.scheduleParenBlink(),13==t)e.ctrlKey&&!e.altKey?this.reparseBuffer():(select.insertNewlineAtCursor(this.win),this.indentAtCursor(),select.scrollToCursor(this.container)),e.stop();else if(9==t&&"default"!=this.options.tabMode)this.handleTab(!e.ctrlKey&&!e.shiftKey),e.stop();else if(32==t&&e.shiftKey&&"default"==this.options.tabMode)this.handleTab(!0),e.stop();else if(36!=t||e.shiftKey)if(219!=t&&221!=t||!e.ctrlKey||e.altKey)if(!e.metaKey||e.shiftKey||37!=t&&39!=t)!e.ctrlKey&&!e.metaKey||e.altKey||(e.shiftKey&&90==t||89==t?(select.scrollToNode(this.history.redo()),e.stop()):90==t||8==t?(select.scrollToNode(this.history.undo()),e.stop()):83==t&&this.options.saveFunction&&(this.options.saveFunction(),e.stop()));else{var n=select.selectionTopNode(this.container);if(!1===n||!this.container.firstChild)return;if(37==t)select.focusAfterNode(i(n),this.container);else{var o=r(n,this.container);select.focusAfterNode(o?o.previousSibling:this.container.lastChild,this.container)}e.stop()}else this.blinkParens(e.shiftKey),e.stop();else this.home()&&e.stop()},keyPress:function(e){var t=/indent|default/.test(this.options.tabMode)&&c.Parser.electricChars;this.frozen&&(!this.keyFilter||this.keyFilter(e.keyCode))||13==e.code||9==e.code&&"default"!=this.options.tabMode||32==e.keyCode&&e.shiftKey&&"default"==this.options.tabMode?e.stop():t&&-1!=t.indexOf(e.character)&&this.parent.setTimeout(method(this,"indentAtCursor"),0)},keyUp:function(e){this.cursorActivity(h(e.keyCode))},indentLineAfter:function(e,t){var n=e?e.nextSibling:this.container.firstChild;n&&!hasClass(n,"whitespace")&&(n=null);var i=n?n.nextSibling:e?e.nextSibling:this.container.firstChild,r=e&&i&&i.currentText?i.currentText:"",o=0,s=n?n.currentText.length:0;null!=t&&"shift"==this.options.tabMode?o=t?s+indentUnit:Math.max(0,s-indentUnit):e?o=e.indentation(r,s,t):c.Parser.firstIndentation&&(o=c.Parser.firstIndentation(r,s,t));var a=o-s;return a<0?0==o?(i&&select.snapshotMove(n.firstChild,i.firstChild,0),removeElement(n),n=null):(select.snapshotMove(n.firstChild,n.firstChild,a,!0),n.currentText=makeWhiteSpace(o),n.firstChild.nodeValue=n.currentText):a>0&&(n?(n.currentText=makeWhiteSpace(o),n.firstChild.nodeValue=n.currentText):(n=makePartSpan(makeWhiteSpace(o),this.doc),n.className="whitespace",e?insertAfter(n,e):this.container.insertBefore(n,this.container.firstChild)),i&&select.snapshotMove(i.firstChild,n.firstChild,s,!1,!0)),0!=a&&this.addDirtyNode(e),n},highlightAtCursor:function(){var e=select.selectionTopNode(this.container,!0),t=select.selectionTopNode(this.container,!1);if(!1!==e&&!1!==t)return select.markSelection(this.win),!1!==this.highlight(e,r(t,this.container),!0,20)&&(select.selectMarked(),!0)},handleTab:function(e){"spaces"==this.options.tabMode?select.insertTabAtCursor(this.win):this.reindentSelection(e)},home:function(){var e=select.selectionTopNode(this.container,!0),t=e;if(!1===e||e&&!e.isPart&&"BR"!=e.nodeName||!this.container.firstChild)return!1;for(;e&&"BR"!=e.nodeName;)e=e.previousSibling;var n=e?e.nextSibling:this.container.firstChild;return n&&n!=t&&n.isPart&&hasClass(n,"whitespace")?select.focusAfterNode(n,this.container):select.focusAfterNode(e,this.container),!0},scheduleParenBlink:function(){this.parenEvent&&this.parent.clearTimeout(this.parenEvent);var e=this;this.parenEvent=this.parent.setTimeout(function(){e.blinkParens()},300)},blinkParens:function(e){function t(e){if(e.currentText){var t=e.currentText.match(/^[\s\u00a0]*([\(\)\[\]{}])[\s\u00a0]*$/);return t&&t[1]}}function n(e){return/[\(\[\{]/.test(e)}function i(e,t){e.style.fontWeight="bold",e.style.color=t?"#8F8":"#F88",s.parent.setTimeout(function(){e.style.fontWeight="",e.style.color=""},500)}if(window.select){this.parenEvent&&this.parent.clearTimeout(this.parenEvent),this.parenEvent=null;var o,s=this,a=select.selectionTopNode(this.container,!0);if(a&&this.highlightAtCursor()&&(a=select.selectionTopNode(this.container,!0))&&((o=t(a))||(a=a.nextSibling)&&(o=t(a)))){var c=a.className,h=n(o);for(matching[o];;){var l=function(){for(var e,i=[],r=!0,o=a;o;o=h?o.nextSibling:o.previousSibling)if(o.className==c&&"SPAN"==o.nodeName&&(e=t(o))){if(n(e)==h?i.push(e):i.length?i.pop()!=matching[e]&&(r=!1):r=!1,!i.length)break}else if(o.dirty||"SPAN"!=o.nodeName&&"BR"!=o.nodeName)return{node:o,status:"dirty"};return{node:o,status:o&&r}}();{if("dirty"!=l.status){i(a,l.status),l.node&&(i(l.node,l.status),e&&select.focusAfterNode(l.node.previousSibling,this.container));break}this.highlight(l.node,r(l.node)),l.node.dirty=!1}}}}},indentAtCursor:function(e){if(this.container.firstChild&&this.highlightAtCursor()){var t=select.selectionTopNode(this.container,!1);if(!1!==t){var n=i(t),r=this.indentLineAfter(n,e);t==n&&r&&(t=r),t==r&&select.focusAfterNode(t,this.container)}}},indentRegion:function(e,t,n){var o=e=i(e),s=e&&i(e.previousSibling);"BR"!=t.nodeName&&(t=r(t,this.container));do{var a=r(o,this.container);o&&this.highlight(s,a,!0),this.indentLineAfter(o,n),s=o,o=a}while(o!=t);select.setCursorPos(this.container,{node:e,offset:0},{node:t,offset:0})},cursorActivity:function(e){internetExplorer&&(this.container.createTextRange().execCommand("unlink"),this.selectionSnapshot=select.selectionCoords(this.win));var t=this.options.cursorActivity;if(!e||t){var n=select.selectionTopNode(this.container,!1);if(!1===n||!this.container.firstChild)return;n=n||this.container.firstChild,t&&t(n),e||(this.scheduleHighlight(),this.addDirtyNode(n))}},reparseBuffer:function(){forEach(this.container.childNodes,function(e){e.dirty=!0}),this.container.firstChild&&this.addDirtyNode(this.container.firstChild)},addDirtyNode:function(e){if(e=e||this.container.firstChild){for(var t=0;t<this.dirty.length;t++)if(this.dirty[t]==e)return;3!=e.nodeType&&(e.dirty=!0),this.dirty.push(e)}},scheduleHighlight:function(){var e=this;this.parent.clearTimeout(this.highlightTimeout),this.highlightTimeout=this.parent.setTimeout(function(){e.highlightDirty()},this.options.passDelay)},getDirtyNode:function(){for(;this.dirty.length>0;){var e=this.dirty.pop();try{for(;e&&e.parentNode!=this.container;)e=e.parentNode;if(e&&(e.dirty||3==e.nodeType))return e}catch(e){}}return null},highlightDirty:function(e){if(window.select){this.options.readOnly||select.markSelection(this.win);for(var t,n=e?null:o()+this.options.passTime;o()<n&&(t=this.getDirtyNode());){var i=this.highlight(t,n);i&&i.node&&i.dirty&&this.addDirtyNode(i.node)}return this.options.readOnly||select.selectMarked(),t&&this.scheduleHighlight(),0==this.dirty.length}},documentScanner:function(e){var t=this,n=null;return function(){if(window.select){n&&n.parentNode!=t.container&&(n=null),select.markSelection(t.win);var i=t.highlight(n,o()+e,!0);select.selectMarked();var r=i?i.node&&i.node.nextSibling:null;n=n==r?null:r,t.delayScanning()}}},delayScanning:function(){this.scanner&&(this.parent.clearTimeout(this.documentScan),this.documentScan=this.parent.setTimeout(this.scanner,this.options.continuousScanning))},highlight:function(e,t,i,r){function s(e,t){return!t.reduced&&t.currentText==e.value&&t.className==e.style}function a(e,t){e.currentText=e.currentText.substring(t),e.reduced=!0}function h(e){var t=makePartSpan(e.value,u.doc);return t.className=e.style,t}function l(e){e?((x||e.nextSibling!=e.oldNextSibling)&&u.history.touch(e),e.oldNextSibling=e.nextSibling):((x||u.container.firstChild!=u.container.oldFirstChild)&&u.history.touch(e),u.container.oldFirstChild=u.container.firstChild)}var d=this.container,u=this,f=this.options.activeTokens,p="number"==typeof t?t:null;if(d.firstChild){for(;e&&(!e.parserFromHere||e.dirty);){if(null!=r&&"BR"==e.nodeName&&--r<0)return!1;e=e.previousSibling}if(!e||e.nextSibling){var g=n(e?e.nextSibling:d.firstChild),y=stringStream(g),m=e?e.parserFromHere(y):c.Parser.make(y),v={current:null,get:function(){return this.current||(this.current=g.nodes.shift()),this.current},next:function(){this.current=null},remove:function(){d.removeChild(this.get()),this.current=null},getNonEmpty:function(){for(var e=this.get();e&&"SPAN"==e.nodeName&&""==e.currentText;){var t=e;this.remove(),e=this.get(),select.snapshotMove(t.firstChild,e&&(e.firstChild||e),0)}return e}},x=!1,C=!0,S=0;return forEach(m,function(n){var r=v.getNonEmpty();if("\n"==n.value){if("BR"!=r.nodeName)throw"Parser out of sync. Expected BR.";if(!r.dirty&&r.indentation||(x=!0),l(e),e=r,r.parserFromHere=m.copy(),r.indentation=n.indentation,r.dirty=!1,null==p&&r==t)throw StopIteration;if(null!=p&&o()>=p||!x&&!C&&S>1&&!i)throw StopIteration;C=x,x=!1,S=0,v.next()}else{if("SPAN"!=r.nodeName)throw"Parser out of sync. Expected SPAN.";if(r.dirty&&(x=!0),S++,s(n,r))r.dirty=!1,v.next();else{x=!0;var c=h(n);d.insertBefore(c,r),f&&f(c,n,u);for(var g=n.value.length,y=0;g>0;){r=v.get();var N=r.currentText.length;select.snapshotReplaceNode(r.firstChild,c.firstChild,g,y),N>g?(a(r,g),g=0):(g-=N,y+=N,v.remove())}}}}),l(e),webkitLastLineHack(this.container),{node:v.getNonEmpty(),dirty:x}}}}},c}();addEventHandler(window,"load",function(){var e=window.frameElement.CodeMirror;e.editor=new Editor(e.options),this.parent.setTimeout(method(e,"init"),0)});